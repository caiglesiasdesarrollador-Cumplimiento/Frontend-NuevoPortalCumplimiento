---
id: stepper-dynamic-form-structure
name: Estructura para formularios din√°micos con stepper
description: Gu√≠a para crear formularios multi-paso usando stepper + formularios din√°micos, con navegaci√≥n y validaci√≥n por pasos.
globs:
  - containers/**/*form*/**
  - containers/**/*dynamic*/**
  - containers/**/*stepper*/**
  - "**/*step*.config.ts"
  - "**/*form*.component.ts"
type: comment
alwaysApply: true
---

# Estructura para formularios din√°micos con stepper

Estructura est√°ndar para formularios **multi-paso** con navegaci√≥n usando `lib-tb-stepper` + `lib-tb-dynamic-form`.

## üìÅ Estructura de carpetas requerida:

```
src/app/containers/mi-formulario-stepper/
‚îú‚îÄ‚îÄ configs/                              # üìÇ Configuraciones por pasos
‚îÇ   ‚îú‚îÄ‚îÄ config-step-1/                   # üìÇ Configuraciones del paso 1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nombre.ts                    # ‚öôÔ∏è Config individual por campo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email.ts                     # ‚öôÔ∏è Config individual por campo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ step1-personal-info.config.ts # üìã Config principal del paso 1
‚îÇ   ‚îú‚îÄ‚îÄ config-step-2/                   # üìÇ Configuraciones del paso 2
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pais.ts                      # ‚öôÔ∏è Config individual por campo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ciudades.ts                  # ‚öôÔ∏è Config individual por campo
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ step2-location-info.config.ts # üìã Config principal del paso 2
‚îÇ   ‚îî‚îÄ‚îÄ config-step-N/                   # üìÇ Configuraciones de pasos adicionales
‚îÇ       ‚îî‚îÄ‚îÄ stepN-section.config.ts     # üìã Config principal del paso N
‚îú‚îÄ‚îÄ mi-formulario-stepper.component.ts    # üéÆ L√≥gica principal + stepper
‚îú‚îÄ‚îÄ mi-formulario-stepper.component.html  # üñºÔ∏è Template con stepper
‚îú‚îÄ‚îÄ mi-formulario-stepper.component.scss  # üé® Estilos del stepper
‚îú‚îÄ‚îÄ mi-formulario-stepper.interface.ts    # üìù Interfaces y tipos
‚îú‚îÄ‚îÄ mi-formulario-stepper.module.ts       # üì¶ M√≥dulo con stepper
‚îú‚îÄ‚îÄ mi-formulario-stepper-routing.module.ts # üõ£Ô∏è Rutas del m√≥dulo
‚îî‚îÄ‚îÄ mi-formulario-stepper.component.spec.ts # üß™ Tests unitarios
```

## üî• **REGLA CR√çTICA: formId y name OBLIGATORIOS EN TODOS LOS PASOS**

**CR√çTICO**: Cada campo en cada paso DEBE tener `formId` y `name` definidos. Sin estos, TODO el stepper falla y no renderiza ning√∫n paso.

### **‚úÖ PATR√ìN OBLIGATORIO POR PASO:**
```typescript
// ‚úÖ CORRECTO: config-step-1/nombre.ts
export const nombre: ILibTbDynamicFormConfigType = {
  tbType: 'input',
  containerId: 'step1-personal-info-container',
  formId: 'nombre',              // ‚úÖ OBLIGATORIO: Para Angular FormControl
  custom: {
    name: 'nombre',              // ‚úÖ OBLIGATORIO: Debe coincidir con formId
    label: 'Nombre completo',
    placeholder: 'Ingresa tu nombre',
  }
};

// ‚úÖ CORRECTO: config-step-2/pais.ts
export const pais: ILibTbDynamicFormConfigType = {
  tbType: 'dropdown',
  containerId: 'step2-location-container',
  formId: 'pais',                // ‚úÖ OBLIGATORIO: Para Angular FormControl
  custom: {
    name: 'pais',                // ‚úÖ OBLIGATORIO: Debe coincidir con formId
    label: 'Pa√≠s',
    options: [...],
  }
};
```

### **üö® FALLA CR√çTICA EN STEPPERS:**
- ‚ùå **UN solo campo sin formId/name** ‚Üí TODO el stepper se rompe
- ‚ùå **Stepper no renderiza NING√öN paso** ‚Üí Aparenta estar vac√≠o
- ‚ùå **Change detection completamente roto** ‚Üí Clicks no funcionan
- ‚ùå **Navegaci√≥n imposible** ‚Üí Botones Anterior/Siguiente fallan
- ‚ùå **Usuario ve aplicaci√≥n rota** ‚Üí Experiencia completamente degradada

### **‚úÖ VERIFICACI√ìN OBLIGATORIA:**
```typescript
// ‚úÖ CHECKLIST ANTES DE IMPLEMENTAR STEPPER:
// PASO 1: ¬øTODOS los campos tienen formId y name?
// PASO 2: ¬øTODOS los campos tienen formId y name?
// PASO N: ¬øTODOS los campos tienen formId y name?
// ¬øNombres √∫nicos en TODO el formulario?
// ¬øformId === custom.name en TODOS los campos?
```

## üéØ Reglas de nomenclatura:

### **Organizaci√≥n por carpetas de paso:**
```
configs/
‚îú‚îÄ‚îÄ config-step-1/          # ‚úÖ Todos los configs del paso 1
‚îÇ   ‚îú‚îÄ‚îÄ nombre.ts           # Campo individual
‚îÇ   ‚îú‚îÄ‚îÄ email.ts            # Campo individual  
‚îÇ   ‚îî‚îÄ‚îÄ step1-*.config.ts   # Config principal del paso
‚îú‚îÄ‚îÄ config-step-2/          # ‚úÖ Todos los configs del paso 2
‚îÇ   ‚îú‚îÄ‚îÄ pais.ts             # Campo individual
‚îÇ   ‚îú‚îÄ‚îÄ ciudades.ts         # Campo individual
‚îÇ   ‚îî‚îÄ‚îÄ step2-*.config.ts   # Config principal del paso
‚îî‚îÄ‚îÄ config-step-N/          # ‚úÖ Pasos adicionales
```

### **Beneficios de esta organizaci√≥n:**
‚úÖ **Escalabilidad**: F√°cil agregar m√°s pasos sin saturar una carpeta  
‚úÖ **Claridad**: Cada paso tiene su propia carpeta autocontenida  
‚úÖ **Mantenimiento**: F√°cil encontrar y modificar configs espec√≠ficos de un paso  
‚úÖ **Imports limpios**: Paths m√°s organizados en las importaciones  
‚úÖ **Colaboraci√≥n**: Equipos pueden trabajar en pasos diferentes sin conflictos

### **Configuraciones de pasos (configs/config-step-X/):**
```typescript
// configs/config-step-1/step1-personal-info.config.ts
import { ILibTbDynamicForm } from 'tech-block-lib';
import { nombre } from './nombre';
import { email } from './email';

export const step1PersonalInfoForm = (): ILibTbDynamicForm => {
  return {
    validateOnSubmit: true,
    class: 'grid grid-cols-1 gap-6',
    configContainers: [
      {
        id: 'step1-header-container',
        tagName: 'header',
        class: 'text-center mb-6'
      },
      {
        id: 'step1-personal-info-container',
        tagName: 'section',
        class: 'bg-white p-6 rounded-lg shadow-sm border border-gray-200'
      }
    ],
    config: [
      {
        containerId: 'step1-header-container',
        htmlContent: '<h3 class="lib-tb-h5-bold">Paso 1: Informaci√≥n Personal</h3>'
      },
      {
        containerId: 'step1-personal-info-container',
        htmlContent: '<p class="lib-tb-body-medium text-gray-600 mb-4">Ingresa tu informaci√≥n personal b√°sica</p>'
      },
      nombre,  // containerId: 'step1-personal-info-container'
      email,   // containerId: 'step1-personal-info-container'
    ]
  };
};
```

### **Configuraciones individuales (configs/config-step-X/):**
```typescript
// configs/config-step-1/nombre.ts  
export const nombre: ILibTbDynamicFormConfigType = {
  tbType: 'input',
  containerId: 'step1-personal-info-container', // ‚úÖ ID espec√≠fico del paso
  formId: 'nombre',
  custom: {
    name: 'nombre',
    label: 'Nombre completo',
    placeholder: 'Ingresa tu nombre',
  },
  formProps: {
    validators: [Validators.required, Validators.minLength(2)]
  }
};
```

### **Componente principal con stepper:**
```typescript
// mi-formulario-stepper.component.ts
import { ILibTbStepper, ILibTbDynamicForm, ILibTbButton } from 'tech-block-lib';
import { step1PersonalInfoForm } from './configs/config-step-1/step1-personal-info.config';
import { step2LocationInfoForm } from './configs/config-step-2/step2-location-info.config';

@Component({
  selector: 'mi-formulario-stepper',
  templateUrl: './mi-formulario-stepper.component.html',
  styleUrls: ['./mi-formulario-stepper.component.scss']
})
export class MiFormularioStepperComponent {
  currentStep = 0; // ‚úÖ Control del paso actual

  // ‚úÖ OBLIGATORIO: Configuraci√≥n del stepper
  stepperConfig: ILibTbStepper = {
    activeIndex: 0,
    readonly: false,
    type: 'number', // o 'icon' o 'mix'
    items: [
      {
        label: 'Informaci√≥n Personal',
        icon: 'fal fa-user',
        command: () => this.goToStep(0),
      },
      {
        label: 'Ubicaci√≥n',
        icon: 'fal fa-map-marker-alt',
        command: () => this.goToStep(1),
      },
    ],
    libTbActiveIndexChange: (index: number) => {
      this.currentStep = index;
    },
  };

  // ‚úÖ OBLIGATORIO: Un formulario din√°mico por paso
  step1Form: ILibTbDynamicForm = step1PersonalInfoForm();
  step2Form: ILibTbDynamicForm = step2LocationInfoForm();

  // ‚úÖ OBLIGATORIO: Botones de navegaci√≥n usando propiedades nativas de tech-block-lib
  btnNext: ILibTbButton = {
    label: 'Siguiente',
    icon: 'fal fa-arrow-right',
    iconPosition: 'right',
    styleBtn: 'fill',
    typeBtn: 'primary',
    libTbClick: () => this.nextStep(),
  };

  btnPrevious: ILibTbButton = {
    label: 'Anterior', 
    icon: 'fal fa-arrow-left',
    iconPosition: 'left',
    styleBtn: 'stroke',
    typeBtn: 'secondary',
    libTbClick: () => this.previousStep(),
  };

  btnSubmit: ILibTbButton = {
    label: 'Enviar',
    icon: 'fal fa-paper-plane',
    iconPosition: 'right',
    styleBtn: 'fill',
    typeBtn: 'primary',
    libTbClick: () => this.submitForm(),
  };

  // ‚úÖ OBLIGATORIO: M√©todos de navegaci√≥n
  goToStep(step: number): void {
    if (step > this.currentStep && !this.validateCurrentStep()) {
      return; // No permitir avanzar sin validar
    }
    this.currentStep = step;
    this.stepperConfig.activeIndex = step;
  }

  nextStep(): void {
    if (this.currentStep < this.stepperConfig.items!.length - 1 && this.validateCurrentStep()) {
      this.currentStep++;
      this.stepperConfig.activeIndex = this.currentStep;
    }
  }

  previousStep(): void {
    if (this.currentStep > 0) {
      this.currentStep--;
      this.stepperConfig.activeIndex = this.currentStep;
    }
  }

  validateCurrentStep(): boolean {
    const currentForm = this.getCurrentStepForm();
    currentForm.libTbCallSubmit?.();
    return currentForm.form?.valid ?? false;
  }

  private getCurrentStepForm(): ILibTbDynamicForm {
    switch (this.currentStep) {
      case 0: return this.step1Form;
      case 1: return this.step2Form;
      default: return this.step1Form;
    }
  }

  submitForm(): void {
    // Validar todos los pasos antes del env√≠o final
    const allValid = this.stepperConfig.items!.every((_, index) => {
      this.currentStep = index;
      return this.validateCurrentStep();
    });

    if (allValid) {
      // Combinar datos de todos los formularios
      const allData = {
        ...this.step1Form.form?.value,
        ...this.step2Form.form?.value,
      };
      console.log('Formulario completo:', allData);
      // Enviar datos...
    }
  }

  // ‚úÖ M√©todos auxiliares para el template
  get isFirstStep(): boolean {
    return this.currentStep === 0;
  }

  get isLastStep(): boolean {
    return this.currentStep === (this.stepperConfig.items!.length - 1);
  }
}
```

## üì¶ M√≥dulo requerido:

```typescript
// mi-formulario-stepper.module.ts
import { 
  LibTbStepperModule, 
  LibTbDynamicFormModule, 
  LibTbButtonModule 
} from 'tech-block-lib';

@NgModule({
  declarations: [MiFormularioStepperComponent],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    LibTbStepperModule,      // ‚úÖ OBLIGATORIO para stepper
    LibTbDynamicFormModule,  // ‚úÖ OBLIGATORIO para formularios din√°micos
    LibTbButtonModule,       // ‚úÖ OBLIGATORIO para botones de navegaci√≥n
    MiFormularioStepperRoutingModule
  ]
})
export class MiFormularioStepperModule {}
```

## üñºÔ∏è Template est√°ndar:

```html
<!-- mi-formulario-stepper.component.html -->
<div class="stepper-form-container">
  <!-- ‚úÖ OBLIGATORIO: Stepper de navegaci√≥n -->
  <div class="stepper-nav">
    <lib-tb-stepper [custom]="stepperConfig"></lib-tb-stepper>
  </div>

  <!-- ‚úÖ OBLIGATORIO: Contenido de pasos con renderizado condicional -->
  <div class="step-content">
    <!-- Paso 1 -->
    <div *ngIf="currentStep === 0" class="step-form">
      <lib-tb-dynamic-form [custom]="step1Form"></lib-tb-dynamic-form>
      
      <div class="navigation-buttons">
        <lib-tb-button [custom]="btnNext"></lib-tb-button>
      </div>
    </div>

    <!-- Paso 2 -->
    <div *ngIf="currentStep === 1" class="step-form">
      <lib-tb-dynamic-form [custom]="step2Form"></lib-tb-dynamic-form>
      
      <div class="navigation-buttons">
        <lib-tb-button [custom]="btnPrevious"></lib-tb-button>
        <lib-tb-button [custom]="btnSubmit"></lib-tb-button>
      </div>
    </div>

    <!-- M√°s pasos seg√∫n sea necesario -->
  </div>
</div>
```

## üé® Estilos base recomendados (siguiendo reglas BEM):

### **Archivo principal: stepper-form.component.scss**
```scss
// ‚úÖ APLICANDO REGLAS BEM: One Block per File + BEM Naming Convention + Limit Nesting

// Bloque principal: stepper-form
.stepper-form {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;

  // ‚úÖ BEM Element: stepper-form__content
  &__content {
    min-height: 400px;
  }

  // ‚úÖ BEM Element: stepper-form__step
  &__step {
    animation: fadeInStep 0.3s ease-in-out;
  }

  // ‚úÖ BEM Element: stepper-form__actions
  &__actions {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;

    // ‚úÖ BEM Modifier: cuando solo hay un bot√≥n
    &--single {
      justify-content: flex-end;
    }
  }

  // ‚úÖ BEM Modifier: stepper-form--mobile
  &--mobile {
    max-width: 100%;
    padding: 1rem;

    .stepper-form__actions {
      flex-direction: column;
    }
  }
}

// ‚úÖ Keyframes para animaci√≥n
@keyframes fadeInStep {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

// ‚úÖ Imports de otros bloques BEM (separados por archivo)
@import './styles/stepper';
@import './styles/form-containers';
```

### **Archivo separado: styles/stepper.scss**
```scss
// ‚úÖ APLICANDO REGLAS BEM: One Block per File - Bloque stepper

.stepper {
  &__container {
    margin-bottom: 2rem;
  }

  &--compact {
    margin-bottom: 1rem;
  }
}
```

### **Archivo separado: styles/form-containers.scss**
```scss
// ‚úÖ APLICANDO REGLAS BEM: One Block per File - Bloque form-container
// ‚úÖ APLICANDO REGLA: No modificar estilos de tech-block-lib

// ‚úÖ Mejoras visuales para containers del formulario (NO para componentes tech-block-lib)
.form-container {
  // ‚úÖ BEM Element: form-container__section
  &__section {
    transition: all 0.3s ease;

    &:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
  }
}
```

### **Reglas BEM aplicadas:**
- ‚úÖ **BEM Naming Convention**: `Block__Element--Modifier`
- ‚úÖ **Limit SCSS Nesting**: M√°ximo 2-3 niveles de anidamiento  
- ‚úÖ **One Block per File**: Cada bloque BEM en su propio archivo
- ‚úÖ **Organizaci√≥n modular**: Imports de archivos separados para diferentes conceptos

## ‚ö†Ô∏è Errores comunes a evitar:

‚ùå **No validar pasos**: Permitir avanzar sin validar el paso actual  
‚ùå **containerId gen√©ricos**: Usar los mismos IDs en todos los pasos  
‚ùå **No manejar el estado**: No sincronizar currentStep con stepper.activeIndex  
‚ùå **L√≥gica en template**: Poner validaciones complejas en el HTML  
‚ùå **Botones mal ubicados**: No mostrar botones contextuales por paso  
‚ùå **No combinar datos**: No unir la informaci√≥n de todos los pasos al final

## üéØ Casos de uso recomendados:

- **Registro de usuarios**: Informaci√≥n personal ‚Üí Configuraci√≥n ‚Üí Confirmaci√≥n
- **Configuraci√≥n de productos**: B√°sico ‚Üí Avanzado ‚Üí Precios ‚Üí Resumen  
- **Procesos de onboarding**: Bienvenida ‚Üí Perfil ‚Üí Preferencias ‚Üí Finalizaci√≥n
- **Formularios largos**: Divisi√≥n l√≥gica en pasos manejables
- **Wizards complejos**: Navegaci√≥n guiada con validaci√≥n progresiva

## üìö Ejemplos de nombres v√°lidos:

‚úÖ **Carpetas por paso**: `config-step-1/`, `config-step-2/`, `config-step-3/`  
‚úÖ **Configs individuales**: `config-step-1/nombre.ts`, `config-step-2/pais.ts`  
‚úÖ **Configs de paso**: `config-step-1/step1-personal.config.ts`, `config-step-2/step2-empresa.config.ts`  
‚úÖ **Componente**: `registro-stepper.component.ts`  
‚úÖ **Interface**: `registro-stepper.interface.ts`  
‚úÖ **M√≥dulo**: `registro-stepper.module.ts`

## üìã Pasos de implementaci√≥n:

### **1. Crear estructura de carpetas:**
```bash
mkdir src/app/containers/mi-formulario-stepper
mkdir src/app/containers/mi-formulario-stepper/configs
mkdir src/app/containers/mi-formulario-stepper/configs/config-step-1
mkdir src/app/containers/mi-formulario-stepper/configs/config-step-2
# Agregar m√°s pasos seg√∫n sea necesario
```

### **2. Crear configs por paso (en orden):**
1. Crear campos individuales en cada carpeta de paso
2. Crear config principal de cada paso
3. Configurar imports en el componente principal
4. Implementar navegaci√≥n del stepper

### **3. Regla de imports:**
```typescript
// ‚úÖ CORRECTO: Import desde carpeta espec√≠fica del paso
import { nombre } from './configs/config-step-1/nombre';
import { step1Form } from './configs/config-step-1/step1-personal.config';

// ‚ùå INCORRECTO: Import cruzado entre pasos
import { nombre } from './configs/config-step-2/nombre'; // nombre debe estar en step-1
```

## üìã Checklist de implementaci√≥n:

‚úÖ Carpetas config-step-X creadas para cada paso  
‚úÖ Stepper configurado con items y navegaci√≥n  
‚úÖ Un ILibTbDynamicForm por paso  
‚úÖ M√©todo goToStep() con validaci√≥n  
‚úÖ M√©todos nextStep() y previousStep()  
‚úÖ Validaci√≥n validateCurrentStep()  
‚úÖ containerId espec√≠ficos por paso  
‚úÖ Botones de navegaci√≥n contextuales  
‚úÖ Template con renderizado condicional  
‚úÖ Animaciones de transici√≥n entre pasos  
‚úÖ Combinaci√≥n de datos al env√≠o final  
‚úÖ Imports organizados por carpetas de paso
