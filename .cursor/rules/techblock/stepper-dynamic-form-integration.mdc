---
id: stepper-dynamic-form-integration
name: IntegraciÃ³n de Stepper con Formularios DinÃ¡micos
description: PatrÃ³n estÃ¡ndar para integrar lib-tb-stepper con lib-tb-dynamic-form en formularios multi-paso usando tech-block-lib.
globs:
  - containers/**/*stepper*/**
  - containers/**/*step*/**
  - "**/*stepper*.component.ts"
  - "**/*step*.config.ts"
type: comment
alwaysApply: true
---

# IntegraciÃ³n de Stepper con Formularios DinÃ¡micos

PatrÃ³n estÃ¡ndar para crear formularios multi-paso combinando `lib-tb-stepper` y `lib-tb-dynamic-form`.

## ğŸ”¥ **REGLA CRÃTICA: formId y name OBLIGATORIOS EN CADA PASO**

**SIEMPRE** incluir **AMBOS** parÃ¡metros en **TODOS** los campos de cada paso del stepper. Sin estos, los formularios multi-paso fallan completamente.

### **âœ… PATRÃ“N OBLIGATORIO PARA STEPPERS:**
```typescript
// âœ… CORRECTO: Campo en cualquier paso del stepper
export const campoStep1: ILibTbDynamicFormConfigType = {
  tbType: 'dropdown|input|number',
  containerId: 'step1-content-container',
  formId: 'campoStep1',           // âœ… OBLIGATORIO: Para Angular FormControl
  custom: {
    name: 'campoStep1',           // âœ… OBLIGATORIO: Debe coincidir con formId
    // ... resto de configuraciÃ³n
  }
};

export const campoStep2: ILibTbDynamicFormConfigType = {
  tbType: 'input',
  containerId: 'step2-content-container', 
  formId: 'campoStep2',           // âœ… OBLIGATORIO: Para Angular FormControl
  custom: {
    name: 'campoStep2',           // âœ… OBLIGATORIO: Debe coincidir con formId
    // ... resto de configuraciÃ³n
  }
};
```

### **ğŸš¨ CRÃTICO PARA STEPPERS:**
- âŒ **Sin formId/name** â†’ Stepper NO renderiza pasos â†’ Parece roto
- âŒ **Errores en cualquier paso** â†’ TODO el stepper falla
- âŒ **NavegaciÃ³n imposible** â†’ Clicks manuales no funcionan
- âŒ **Change detection roto** â†’ Formularios no responden

### **âœ… VERIFICACIÃ“N POR PASO:**
```typescript
// âœ… CHECKLIST para cada paso del stepper:
// Paso 1: Â¿Todos los campos tienen formId y name?
// Paso 2: Â¿Todos los campos tienen formId y name?  
// Paso N: Â¿Todos los campos tienen formId y name?
// Â¿Nombres Ãºnicos across todos los pasos?
```

## ğŸ¯ Estructura del componente principal:

```typescript
import { ILibTbStepper, ILibTbDynamicForm, ILibTbButton } from 'tech-block-lib';

@Component({
  selector: 'mi-formulario-stepper',
  templateUrl: './mi-formulario-stepper.component.html',
  styleUrls: ['./mi-formulario-stepper.component.scss']
})
export class MiFormularioStepperComponent {
  currentStep = 0; // âœ… Control del paso actual

  // âœ… OBLIGATORIO: ConfiguraciÃ³n del stepper
  stepperConfig: ILibTbStepper = {
    activeIndex: 0,
    readonly: false,
    type: 'number', // o 'icon' o 'mix'
    items: [
      {
        label: 'Paso 1: InformaciÃ³n Personal',
        icon: 'fal fa-user',
        command: () => this.goToStep(0),
      },
      {
        label: 'Paso 2: UbicaciÃ³n',
        icon: 'fal fa-map-marker-alt',
        command: () => this.goToStep(1),
      },
    ],
    libTbActiveIndexChange: (index: number) => {
      this.currentStep = index;
    },
  };

  // âœ… OBLIGATORIO: Un formulario dinÃ¡mico por paso
  step1Form: ILibTbDynamicForm = step1ConfigForm();
  step2Form: ILibTbDynamicForm = step2ConfigForm();

  // âœ… OBLIGATORIO: Botones de navegaciÃ³n
  btnNext: ILibTbButton = {
    label: 'Siguiente',
    icon: 'fal fa-arrow-right',
    libTbClick: () => this.nextStep(),
  };

  btnPrevious: ILibTbButton = {
    label: 'Anterior', 
    icon: 'fal fa-arrow-left',
    libTbClick: () => this.previousStep(),
  };

  btnSubmit: ILibTbButton = {
    label: 'Enviar',
    icon: 'fal fa-paper-plane',
    libTbClick: () => this.submitForm(),
  };

  // âœ… OBLIGATORIO: MÃ©todos de navegaciÃ³n
  goToStep(step: number): void {
    if (step > this.currentStep && !this.validateCurrentStep()) {
      return; // No permitir avanzar si el paso actual no es vÃ¡lido
    }
    this.currentStep = step;
    this.stepperConfig.activeIndex = step;
  }

  nextStep(): void {
    if (this.currentStep < this.stepperConfig.items!.length - 1 && this.validateCurrentStep()) {
      this.currentStep++;
      this.stepperConfig.activeIndex = this.currentStep;
    }
  }

  previousStep(): void {
    if (this.currentStep > 0) {
      this.currentStep--;
      this.stepperConfig.activeIndex = this.currentStep;
    }
  }

  validateCurrentStep(): boolean {
    const currentForm = this.getCurrentStepForm();
    currentForm.libTbCallSubmit?.();
    return currentForm.form?.valid ?? false;
  }

  private getCurrentStepForm(): ILibTbDynamicForm {
    switch (this.currentStep) {
      case 0: return this.step1Form;
      case 1: return this.step2Form;
      default: return this.step1Form;
    }
  }

  submitForm(): void {
    // Validar todos los pasos antes del envÃ­o final
    const allValid = this.stepperConfig.items!.every((_, index) => {
      this.currentStep = index;
      return this.validateCurrentStep();
    });

    if (allValid) {
      // Combinar datos de todos los formularios
      const allData = {
        ...this.step1Form.form?.value,
        ...this.step2Form.form?.value,
      };
      console.log('Formulario completo:', allData);
      // Enviar datos...
    }
  }

  // âœ… MÃ©todos auxiliares para el template
  get isFirstStep(): boolean {
    return this.currentStep === 0;
  }

  get isLastStep(): boolean {
    return this.currentStep === (this.stepperConfig.items!.length - 1);
  }
}
```

## ğŸ–¼ï¸ Template estÃ¡ndar:

```html
<div class="stepper-form-container">
  <!-- âœ… OBLIGATORIO: Stepper de navegaciÃ³n -->
  <div class="stepper-nav">
    <lib-tb-stepper [custom]="stepperConfig"></lib-tb-stepper>
  </div>

  <!-- âœ… OBLIGATORIO: Contenido de pasos con renderizado condicional -->
  <div class="step-content">
    <!-- Paso 1 -->
    <div *ngIf="currentStep === 0" class="step-form">
      <lib-tb-dynamic-form [custom]="step1Form"></lib-tb-dynamic-form>
      
      <div class="navigation-buttons">
        <lib-tb-button [custom]="btnNext"></lib-tb-button>
      </div>
    </div>

    <!-- Paso 2 -->
    <div *ngIf="currentStep === 1" class="step-form">
      <lib-tb-dynamic-form [custom]="step2Form"></lib-tb-dynamic-form>
      
      <div class="navigation-buttons">
        <lib-tb-button [custom]="btnPrevious"></lib-tb-button>
        <lib-tb-button [custom]="btnSubmit"></lib-tb-button>
      </div>
    </div>

    <!-- MÃ¡s pasos segÃºn sea necesario -->
  </div>
</div>
```

## ğŸ“¦ MÃ³dulo requerido:

```typescript
import { 
  LibTbStepperModule, 
  LibTbDynamicFormModule, 
  LibTbButtonModule 
} from 'tech-block-lib';

@NgModule({
  declarations: [MiFormularioStepperComponent],
  imports: [
    CommonModule,
    ReactiveFormsModule,
    LibTbStepperModule,      // âœ… OBLIGATORIO para stepper
    LibTbDynamicFormModule,  // âœ… OBLIGATORIO para formularios dinÃ¡micos
    LibTbButtonModule,       // âœ… OBLIGATORIO para botones de navegaciÃ³n
  ]
})
export class MiFormularioStepperModule {}
```

## ğŸ¨ Estilos base recomendados:

```scss
.stepper-form-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
}

.stepper-nav {
  margin-bottom: 2rem;
}

.step-content {
  min-height: 400px;
}

.step-form {
  animation: fadeInStep 0.3s ease-in-out;
}

@keyframes fadeInStep {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.navigation-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 2rem;
  
  &.single-button {
    justify-content: flex-end;
  }
}
```

## âš™ï¸ Configuraciones de paso con containerId especÃ­ficos:

```typescript
// configs/step1-personal.config.ts
export const step1PersonalForm = (): ILibTbDynamicForm => {
  return {
    configContainers: [
      {
        id: 'step1-header-container',    // âœ… ID especÃ­fico del paso
        tagName: 'header',
        class: 'step-header'
      },
      {
        id: 'step1-content-container',   // âœ… ID especÃ­fico del paso
        tagName: 'section', 
        class: 'step-content'
      }
    ],
    config: [
      {
        containerId: 'step1-header-container',
        htmlContent: '<h3>Paso 1: InformaciÃ³n Personal</h3>'
      },
      nombre,    // containerId: 'step1-content-container'
      apellidos, // containerId: 'step1-content-container'
      email,     // containerId: 'step1-content-container'
    ]
  };
};
```

## âš ï¸ Errores comunes a evitar:

âŒ **No validar pasos**: Permitir avanzar sin validar el paso actual  
âŒ **containerId genÃ©ricos**: Usar los mismos IDs en todos los pasos  
âŒ **No manejar el estado**: No sincronizar currentStep con stepper.activeIndex  
âŒ **LÃ³gica en template**: Poner validaciones complejas en el HTML  
âŒ **Botones mal ubicados**: No mostrar botones contextuales por paso  
âŒ **No combinar datos**: No unir la informaciÃ³n de todos los pasos al final

## ğŸ¯ Casos de uso recomendados:

- **Registro de usuarios**: InformaciÃ³n personal â†’ ConfiguraciÃ³n â†’ ConfirmaciÃ³n
- **ConfiguraciÃ³n de productos**: BÃ¡sico â†’ Avanzado â†’ Precios â†’ Resumen  
- **Procesos de onboarding**: Bienvenida â†’ Perfil â†’ Preferencias â†’ FinalizaciÃ³n
- **Formularios largos**: DivisiÃ³n lÃ³gica en pasos manejables
- **Wizards complejos**: NavegaciÃ³n guiada con validaciÃ³n progresiva

## ğŸ“‹ Checklist de implementaciÃ³n:

âœ… Stepper configurado con items y navegaciÃ³n  
âœ… Un ILibTbDynamicForm por paso  
âœ… MÃ©todo goToStep() con validaciÃ³n  
âœ… MÃ©todos nextStep() y previousStep()  
âœ… ValidaciÃ³n validateCurrentStep()  
âœ… containerId especÃ­ficos por paso  
âœ… Botones de navegaciÃ³n contextuales  
âœ… Template con renderizado condicional  
âœ… Animaciones de transiciÃ³n entre pasos  
âœ… CombinaciÃ³n de datos al envÃ­o final
