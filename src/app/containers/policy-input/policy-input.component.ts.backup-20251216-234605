import { Component, OnInit, HostListener, NgZone } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { ChangeDetectorRef } from '@angular/core';
import {
  ILibTbStepper,
  ILibTbDynamicForm,
  ILibTbButton,
  ILibTbBreadcrumb,
  ILibTbFileUploadField,
  ILibTbTable,
  ILibTbAccordion,
  ILibTbAccordionTab,
  ILibTbSnackbar,
  ILibTbModal,
  ILibTbInputNumber,
} from 'tech-block-lib';
import { BreadcrumbService, BreadcrumbItem } from '../../shared/services/breadcrumb.service';
import { QuoteService } from '../../shared/services/quote.service';
import { firstValueFrom } from 'rxjs';
import {
  PolicyInputAction,
  ACTION_LABELS,
  ACTION_LABELS_MOBILE,
  INITIAL_STEP2_DATA,
  MOCK_EXTRACTED_CONTRACT_DATA,
  IPolicyStep2Data,
  ActionLabel,
} from './policy-input.interface';
import { step1PolicyInfoForm } from './configs/config-step-1/step1-policy-info.config';
import { step2ContractInfoForm } from './configs/config-step-2/step2-contract-info.config';
import { sarlaftModalConfig } from './configs/sarlaft-modal.config';
import { MOCK_MANAGEMENT_DATA, IPolicyManagementItem } from '../management/management.interface';

@Component({
  standalone: false,
  selector: 'app-policy-input',
  templateUrl: './policy-input.component.html',
  styleUrls: ['./policy-input.component.scss'],
})
export class PolicyInputComponent implements OnInit {
  currentStep = 0;
  isViewDetailsMode = false; // ‚úÖ Control del paso actual
  isRcSectionEnabled = true; // ‚úÖ Control de habilitaci√≥n de la secci√≥n RC
  
  
  // ‚úÖ Total de prima de coberturas seleccionadas
  totalPrimaSeleccionada = 0;
  
  // ‚úÖ Coberturas Cumplimiento con selecci√≥n
  coberturasCumplimiento = [
    { id: 1, nombre: 'SERIEDAD DE LA OFERTA', porcentaje: 10, valorAsegurado: 15000000, tasa: 0, fechaInicio: '05/05/25', fechaFin: '', tiempoAdicional: '30 d√≠as', fechaVencimiento: '05/11/25', prima: 150000, seleccionada: false },
    { id: 2, nombre: 'MANEJO DEL ANTICIPO', porcentaje: 50, valorAsegurado: 75000000, tasa: 0, fechaInicio: '05/05/25', fechaFin: '', tiempoAdicional: '60 d√≠as', fechaVencimiento: '04/05/26', prima: 750000, seleccionada: false },
    { id: 3, nombre: 'CUMPLIMIENTO', porcentaje: 20, valorAsegurado: 30000000, tasa: 0, fechaInicio: '05/05/25', fechaFin: '', tiempoAdicional: '45 d√≠as', fechaVencimiento: '04/05/26', prima: 300000, seleccionada: false },
    { id: 4, nombre: 'SALARIOS Y PRESTACIONES SOCIALES', porcentaje: 20, valorAsegurado: 30000000, tasa: 0, fechaInicio: '05/05/25', fechaFin: '', tiempoAdicional: '45 d√≠as', fechaVencimiento: '04/05/26', prima: 300000, seleccionada: false },
    { id: 5, nombre: 'PAGO ANTICIPADO', porcentaje: 100, valorAsegurado: 150000000, tasa: 0, fechaInicio: '05/05/25', fechaFin: '', tiempoAdicional: '120 d√≠as', fechaVencimiento: '04/05/26', prima: 1500000, seleccionada: false },
    { id: 6, nombre: 'ESTABILIDAD DE LA OBRA', porcentaje: 30, valorAsegurado: 45000000, tasa: 0, fechaInicio: '05/05/26', fechaFin: '', tiempoAdicional: '90 d√≠as', fechaVencimiento: '04/05/31', prima: 450000, seleccionada: false },
    { id: 7, nombre: 'CALIDAD DEL SERVICIO', porcentaje: 25, valorAsegurado: 37500000, tasa: 0, fechaInicio: '05/05/26', fechaFin: '', tiempoAdicional: '60 d√≠as', fechaVencimiento: '04/05/27', prima: 375000, seleccionada: false },
    { id: 8, nombre: 'BUEN FUNCIONAMIENTO DE LOS EQUIPOS', porcentaje: 15, valorAsegurado: 22500000, tasa: 0, fechaInicio: '05/05/26', fechaFin: '', tiempoAdicional: '45 d√≠as', fechaVencimiento: '04/05/27', prima: 225000, seleccionada: false },
    { id: 9, nombre: 'SUMINISTRO DE REPUESTOS', porcentaje: 10, valorAsegurado: 15000000, tasa: 0, fechaInicio: '05/05/26', fechaFin: '', tiempoAdicional: '30 d√≠as', fechaVencimiento: '04/05/27', prima: 150000, seleccionada: false },
    { id: 10, nombre: 'CALIDAD DE LOS BIENES SUMINISTRADOS', porcentaje: 10, valorAsegurado: 15000000, tasa: 0, fechaInicio: '05/05/26', fechaFin: '', tiempoAdicional: '30 d√≠as', fechaVencimiento: '04/05/27', prima: 150000, seleccionada: false },
  ];
  
  // ‚úÖ M√©todo para seleccionar/deseleccionar cobertura
  toggleCobertura(cobertura: any): void {
    cobertura.seleccionada = !cobertura.seleccionada;
    this.calcularTotalPrima();
  }
  
  // ‚úÖ Calcular total de prima seleccionada
  calcularTotalPrima(): void {
    this.totalPrimaSeleccionada = this.coberturasCumplimiento
      .filter(c => c.seleccionada)
      .reduce((total, c) => total + c.prima, 0);
  }
  
  // ‚úÖ Seleccionar/deseleccionar todas
  toggleTodasCoberturas(event: any): void {
    const seleccionar = event.target.checked;
    this.coberturasCumplimiento.forEach(c => c.seleccionada = seleccionar);
    this.calcularTotalPrima();
  }
  
  // ‚úÖ Contar coberturas seleccionadas
  getCoberturasSeleccionadasCount(): number {
    return this.coberturasCumplimiento.filter(c => c.seleccionada).length;
  }
  
  // ‚úÖ Limpiar selecci√≥n de coberturas
  limpiarSeleccionCoberturas(): void {
    this.coberturasCumplimiento.forEach(c => c.seleccionada = false);
    this.totalPrimaSeleccionada = 0;
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Selecci√≥n limpiada',
      class: 'snackbar-success-theme'
    };
  }
  
  // ‚úÖ Actualizar coberturas
  actualizarCoberturas(): void {
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Coberturas actualizadas',
      class: 'snackbar-success-theme'
    };
  }
  
  // ‚úÖ Guardar coberturas seleccionadas
  guardarCoberturas(): void {
    const seleccionadas = this.coberturasCumplimiento.filter(c => c.seleccionada);
    if (seleccionadas.length === 0) {
      this.snackbarConfig = {
        ...this.snackbarConfig,
        show: true,
        message: '‚ö†Ô∏è Debe seleccionar al menos una cobertura',
        class: 'snackbar-warning-theme'
      };
      return;
    }
    console.log('üíæ Guardando coberturas:', seleccionadas);
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: `‚úÖ ${seleccionadas.length} coberturas guardadas correctamente`,
      class: 'snackbar-success-theme'
    };
  }
  rcAccordionOpen = true; // ‚úÖ Control del acorde√≥n RC
  action: PolicyInputAction = PolicyInputAction.COTIZAR;

  // ‚úÖ CACHE del actionLabel para evitar ExpressionChangedAfterItHasBeenCheckedError
  private _cachedActionLabel: ActionLabel = ACTION_LABELS[PolicyInputAction.COTIZAR];
  private _cachedIsMobile = false;

  // ‚úÖ NUEVA PROPIEDAD: Control de habilitaci√≥n del formulario
  isFormEnabled = true; // Habilitado por defecto ya que cotizar est√° seleccionado

  // ‚úÖ Datos para simular carga de archivo y extracci√≥n
  fileName: string | null = null;
  isProcessing = false;
  step2Data: IPolicyStep2Data = INITIAL_STEP2_DATA;

  // ‚úÖ Control de validaci√≥n del archivo de contrato
  isContractFileRequired = true;
  contractFileError = false;

  // ‚úÖ Propiedades para el formulario paso 1
  tipoProducto = '';
  claveIntermediario = '';
  claveIntermediarioError = false;
  
  // ‚úÖ Lista de claves del intermediario (un intermediario puede tener m√∫ltiples claves)
  clavesIntermediario: { codigo: string; nombre: string }[] = [
    { codigo: '53940', nombre: 'Agente Principal - Zona Norte' },
    { codigo: '53941', nombre: 'Agente Secundario - Zona Centro' },
    { codigo: '53942', nombre: 'Agente Comercial - Zona Sur' },
    { codigo: '12345', nombre: 'Sucursal Bogot√°' },
    { codigo: '67890', nombre: 'Sucursal Medell√≠n' },
    { codigo: '11223', nombre: 'Sucursal Cali' },
  ];
  nombreIntermediario = '';
  selectedFileName: string | null = null;
  selectedFile: File | null = null;
  isUploading = false;
  uploadProgress = 0;
  formSubmitted = false; // Control de validaci√≥n
  showSuccessModal = false; // Modal de √©xito al avanzar al paso 2
  
  // Campos adicionales para Grandes Beneficiarios
  tipoDocumentoAsegurado = '';
  numeroDocumentoAsegurado = '';
  tipoDocumentoTomador = '';
  numeroDocumentoTomador = '';
  programaParametrizado = '';
  programaSeleccionado = '';

  // ‚úÖ Campos de fecha con calendario Seguros Bol√≠var UI
  fechaInicioContrato = '';
  fechaFinContrato = '';
  fechaInicioRC = '2024-08-01';
  fechaFinRC = '2025-07-31';

  // ‚úÖ B√∫squeda de nombres Tomador/Asegurado
  nombreTomador = '';
  nombreAsegurado = '';
  buscandoTomador = false;
  buscandoAsegurado = false;

  // ‚úÖ Errores de validaci√≥n de documentos
  errorDocumentoTomador = '';
  errorDocumentoAsegurado = '';

  // ‚úÖ Reglas de validaci√≥n de documentos Colombia
  documentValidationRules: { [key: string]: { min: number; max: number; pattern: RegExp; message: string; formato: string } } = {
    'CC': {
      min: 6,
      max: 10,
      pattern: /^[0-9]+$/,
      message: 'C√©dula de Ciudadan√≠a debe tener entre 6 y 10 d√≠gitos num√©ricos',
      formato: 'Solo n√∫meros (6-10 d√≠gitos)'
    },
    'CE': {
      min: 6,
      max: 7,
      pattern: /^[0-9]+$/,
      message: 'C√©dula de Extranjer√≠a debe tener entre 6 y 7 d√≠gitos num√©ricos',
      formato: 'Solo n√∫meros (6-7 d√≠gitos)'
    },
    'NIT': {
      min: 9,
      max: 11,
      pattern: /^[0-9]{9}(-[0-9])?$/,
      message: 'NIT debe tener 9 d√≠gitos, opcionalmente con d√≠gito verificador (ej: 900123456-7)',
      formato: '9 d√≠gitos o 9 d√≠gitos-DV'
    },
    'PA': {
      min: 5,
      max: 17,
      pattern: /^[A-Za-z0-9]+$/,
      message: 'Pasaporte debe tener entre 5 y 17 caracteres alfanum√©ricos',
      formato: 'Alfanum√©rico (5-17 caracteres)'
    },
    'TI': {
      min: 10,
      max: 11,
      pattern: /^[0-9]+$/,
      message: 'Tarjeta de Identidad debe tener entre 10 y 11 d√≠gitos num√©ricos',
      formato: 'Solo n√∫meros (10-11 d√≠gitos)'
    }
  };

  // ‚úÖ Modales Cliente no creado y SARLAFT
  showClienteNoCreado = false;
  showSarlaftDesactualizado = false;
  celularCliente = '';
  celularAsesor = '';
  correoTomador = '';
  correoAsesor = '';

  // ‚úÖ Modal: Solicitar Cupo (cuando el tomador no tiene cupo disponible)
  showSolicitarCupo = false;
  estadosFinancierosFile: File | null = null;
  estadosFinancierosFileName: string | null = null;
  actividadEconomica = '';
  isUploadingEstadosFinancieros = false;
  uploadProgressEstadosFinancieros = 0;

  // ‚úÖ Lista de actividades econ√≥micas CIIU
  actividadesEconomicas = [
    { codigo: 'A', nombre: 'Agricultura, ganader√≠a, caza, silvicultura y pesca' },
    { codigo: 'B', nombre: 'Explotaci√≥n de minas y canteras' },
    { codigo: 'C', nombre: 'Industrias manufactureras' },
    { codigo: 'D', nombre: 'Suministro de electricidad, gas, vapor y aire acondicionado' },
    { codigo: 'E', nombre: 'Gesti√≥n de desechos y actividades de saneamiento ambiental' },
    { codigo: 'F', nombre: 'Construcci√≥n' },
    { codigo: 'G', nombre: 'Comercio al por mayor y al por menor' },
    { codigo: 'H', nombre: 'Transporte y almacenamiento' },
    { codigo: 'I', nombre: 'Alojamiento y servicios de comida' },
    { codigo: 'J', nombre: 'Informaci√≥n y comunicaciones' },
    { codigo: 'K', nombre: 'Financieras y de seguros' },
    { codigo: 'L', nombre: 'Actividades inmobiliarias' },
    { codigo: 'M', nombre: 'Actividades profesionales, cient√≠ficas y t√©cnicas' },
    { codigo: 'N', nombre: 'Actividades de servicios administrativos y de apoyo' },
    { codigo: 'O', nombre: 'Administraci√≥n p√∫blica y defensa' },
    { codigo: 'P', nombre: 'Educaci√≥n' },
    { codigo: 'Q', nombre: 'Salud humana y asistencia social' },
    { codigo: 'R', nombre: 'Actividades art√≠sticas, de entretenimiento y recreaci√≥n' },
    { codigo: 'S', nombre: 'Otras actividades de servicios' },
    { codigo: 'T', nombre: 'Actividades de los hogares individuales en calidad de empleadores' },
    { codigo: 'U', nombre: 'Actividades de organizaciones y entidades extraterritoriales' },
  ];

  // ‚úÖ Agente L√≠der - Datos de prueba
  liderClave = '53940';
  liderNombre = 'JUAN CARLOS MARTINEZ LOPEZ';
  liderParticipacion = 10; // ‚úÖ Participaci√≥n fija del l√≠der
  liderComisionPactada = 10;
  liderFormaActuacion = 'Directa';
  liderConvenio = 'Convenio General';

  // ‚úÖ Datos Adicionales de la P√≥liza
  tipoContragarantia = '';
  numeroContragarantia = '';

  // ‚úÖ Coaseguro
  tipoCoaseguro = 'sin-coaseguro'; // 'sin-coaseguro' | 'cedido' | 'aceptado'
  
  // Coaseguro Cedido
  coasegurosCedidos: any[] = [];
  showModalCoaseguroCedido = false;
  coaseguroCedidoCoaseguradora = '';
  coaseguroCedidoParticipacion = 0;
  coaseguroCedidoGastosAdmin = 0;
  coaseguroCedidoNumeroPol = '';
  coaseguroCedidoCertificado = '';
  coaseguroCedidoEditIndex: number | null = null; // Para edici√≥n
  
  // Alerta de confirmaci√≥n para eliminar coaseguro
  showAlertaEliminarCoaseguro = false;
  coaseguroAEliminarIndex: number | null = null;
  
  // Ordenamiento y Paginaci√≥n Coaseguros Cedidos
  coasegurosCedidosSortColumn = '';
  coasegurosCedidosSortDirection: 'asc' | 'desc' = 'asc';
  coasegurosCedidosPage = 1;
  coasegurosCedidosPageSize = 5;
  
  // Coaseguro Aceptado
  coaseguroAceptadoCoaseguradora = '';
  coaseguroAceptadoNumeroPol = '';
  coaseguroAceptadoCertificado = '';
  coaseguroAceptadoParticipacion = 20;
  
  // Lista de coaseguradoras (para adicionar - NO incluye Bol√≠var porque es fijo)
  listaCoaseguradoras = [
    { codigo: '1', nombre: '1 - ALLIANZ SEGUROS S.A.' },
    { codigo: '2', nombre: '2 - SEGUROS GENERALES SURAMERICANA S.A.' },
    { codigo: '3', nombre: '3 - AXA COLPATRIA S.A.' },
    { codigo: '7', nombre: '7 - LA PREVISORA S.A. COMPA√ëIA DE SEGUROS' },
    { codigo: '11', nombre: '11 - ROYAL & SUN ALLIANCE SEGUROS COLOMBIA S.A.' },
    { codigo: '19', nombre: '19 - ZLS ASEGURADORA DE COLOMBIA S.A.' },
    { codigo: '20', nombre: '20 - AGRICOLA DE SEGUROS' },
    { codigo: '21', nombre: '21 - CONDOR CIA DE SEGUROS GENERALES' },
    { codigo: '22', nombre: '22 - HDI SEGUROS S.A.' },
    { codigo: '23', nombre: '23 - SEGUROS ATLAS SEGUROS GENERALES' },
    { codigo: '24', nombre: '24 - LIBERTY SEGUROS S.A.' },
    { codigo: '26', nombre: '26 - SEGUROS DEL ESTADO S.A.' },
    { codigo: '28', nombre: '28 - MAPFRE SEGUROS GENERALES DE COLOMBIA S.A.' },
    { codigo: '29', nombre: '29 - SEGUROS ALFA S.A.' },
    { codigo: '33', nombre: '33 - LA EQUIDAD SEGUROS GENERALES' }
  ];
  
  // Coaseguradora Bol√≠var (siempre fija cuando es Cedido)
  readonly COASEGURADORA_BOLIVAR = '999 - SEGUROS COMERCIALES BOLIVAR S.A.';

  // ‚úÖ Agentes adicionales
  agentesAdicionales: any[] = [];
  showModalAgente = false;
  agenteClave = '';
  agenteNombre = '';
  agenteParticipacion = 0;
  agenteFormaActuacion = '';
  agenteConvenio = '';
  errorParticipacion = '';
  agenteEditIndex: number | null = null;
  
  // ‚úÖ Ordenamiento de tabla de agentes
  agentesSortColumn: string = '';
  agentesSortDirection: 'asc' | 'desc' = 'asc';
  
  // ‚úÖ Ordenamiento de tabla de cotizaciones
  cotizacionesSortColumn: string = '';
  cotizacionesSortDirection: 'asc' | 'desc' = 'asc';

  // ‚úÖ M√©todo para calcular el porcentaje disponible
  get porcentajeDisponible(): number {
    const totalAgentes = this.agentesAdicionales.reduce((sum, a) => sum + a.participacion, 0);
    // Si estamos editando, excluir la participaci√≥n del agente que se est√° editando
    if (this.agenteEditIndex !== null) {
      const participacionActual = this.agentesAdicionales[this.agenteEditIndex]?.participacion || 0;
      return 100 - this.liderParticipacion - totalAgentes + participacionActual;
    }
    return 100 - this.liderParticipacion - totalAgentes;
  }

  // ‚úÖ Control de loading para el bot√≥n de generar cotizaci√≥n
  loading = false;

  // ‚úÖ Control de vista de resumen de cotizaci√≥n
  showQuoteSummary = false;
  quoteSummaryData: any = null;

  // ‚úÖ Control para mostrar secci√≥n de grandes beneficiarios
  showGrandesBeneficiarios = false;

  // ‚úÖ Objeto del contrato de Responsabilidad Civil
  objetoContratoValue =
    'Objeto del contrato de Responsabilidad Civil predefinido y no editable, basado en las condiciones generales de la p√≥liza.';

  // ‚úÖ USANDO TECH-BLOCK-LIB: Configuraci√≥n del snackbar para notificaciones
  snackbarConfig: ILibTbSnackbar = {
    show: false,
    message: '',
    position: 'top-right',
    orientation: 'horizontal',
    life: 5000, // 5 segundos
    autoZIndex: true,
    baseZIndex: 1000,
    showTransitionOptions: '300ms ease-out',
    hideTransitionOptions: '250ms ease-in',
    class: 'snackbar-success-theme',
  };

  // ‚úÖ USANDO TECH-BLOCK-LIB: Configuraci√≥n del modal SARLAFT (se inicializa din√°micamente)
  sarlaftModal: ILibTbModal = sarlaftModalConfig(this.action);

  // ‚úÖ NUEVO: Modal para "Cliente no creado" (se inicializa din√°micamente)
  clienteNoCreadoModal: ILibTbModal = this.createClienteNoCreadoModalConfig();

  // ‚úÖ Propiedades para el modal SARLAFT
  sarlaftClientPhone = '';
  sarlaftAdvisorPhone = '';

  // ‚úÖ Configuraciones para inputs de n√∫mero del modal SARLAFT
  sarlaftClientPhoneInput: ILibTbInputNumber = {
    name: 'sarlaftClientPhone',
    label: 'Celular cliente',
    ngModel: undefined,
    placeholder: 'Ingresa el n√∫mero de celular del cliente',
    maxlength: 10,
    required: true,
    showButtons: false,
    format: false,
    class: 'w-full',
    libTbChange: (value: number) => {
      this.sarlaftClientPhone = value?.toString() || '';
    },
  };

  sarlaftAdvisorPhoneInput: ILibTbInputNumber = {
    name: 'sarlaftAdvisorPhone',
    label: 'N√∫mero celular asesor',
    ngModel: undefined,
    placeholder: 'Ingresa el n√∫mero de celular del asesor',
    maxlength: 10,
    required: true,
    showButtons: false,
    format: false,
    class: 'w-full',
    libTbChange: (value: number) => {
      this.sarlaftAdvisorPhone = value?.toString() || '';
    },
  };

  // ‚úÖ USANDO TECH-BLOCK-LIB: Configuraci√≥n del acorde√≥n para secci√≥n RC
  rcAccordionConfig: ILibTbAccordion = {
    multiple: false, // Solo un tab activo a la vez
    expandIcon: 'fa-solid fa-chevron-down',
    collapseIcon: 'fa-solid fa-chevron-up',
    class: 'rc-accordion',
    libTbActiveIndexChange: (index: number) => {
      // Solo expandir/contraer cuando el checkbox est√° habilitado
      if (this.isRcSectionEnabled) {
        console.log('Acorde√≥n RC cambi√≥ a √≠ndice:', index);
      }
    },
  };

  // ‚úÖ USANDO TECH-BLOCK-LIB: Configuraci√≥n del tab del acorde√≥n RC
  rcAccordionTab: ILibTbAccordionTab = {
    header: 'Detalles RC y Coberturas',
    selected: true, // Inicialmente expandido
    disabled: false,
    icon: 'fa-solid fa-file-contract',
    libTbSelectedChange: (e: any) => {
      console.log('Tab RC seleccionado/deseleccionado:', e);
    },
  };

  // ‚úÖ Configuraci√≥n de breadcrumb
  breadcrumbConfig: ILibTbBreadcrumb = {
    items: [],
  };

  // ‚úÖ Configuraci√≥n para las opciones Cotizar y Emitir
  selectedAction: 'cotizar' | 'emitir' | null = 'cotizar'; // ‚úÖ Cotizar seleccionado por defecto
  selectedEmitirOption: 'cotizacion-existente' | 'poliza-nueva' | null = null;

  // ‚úÖ Vista de tabla de cotizaciones existentes
  showCotizacionesTable = false;
  showCotizacionDetalle = false;
  cotizacionSeleccionada: any = null;

  // ‚úÖ Datos mock de cotizaciones existentes
  cotizacionesExistentes = [
    {
      id: 'COT-2024-001',
      tipo: 'Cotizaci√≥n',
      numero: 'COT-2024-001',
      tomador: { nombre: 'Empresa XYZ Ltda', documento: '900654321-2' },
      producto: 'Responsabilidad Civil',
      valorAsegurado: 300000000,
      estado: 'Cotizada',
      fechaCreacion: '19/1/2024',
      cupoDisponible: 1200000000,
      datosGenerales: {
        numeroContrato: 'CONT-GENERAL-2024-001',
        tipoDocTomador: 'NIT',
        numDocTomador: '900654321-2',
        nombreTomador: 'Empresa XYZ Ltda',
        moneda: 'COP',
        tipoDocAsegurado: 'NIT',
        numDocAsegurado: '900654321-2',
        nombreAsegurado: 'Empresa XYZ Ltda'
      },
      ubicacionRiesgo: {
        departamento: 'Antioquia',
        municipio: 'Medell√≠n',
        direccion: 'Calle 50 # 25-30, Centro'
      },
      detallesContrato: {
        valorContrato: 300000000,
        fechaInicio: '2024-02-15',
        duracion: '12 meses',
        fechaFin: '2025-02-15'
      },
      coberturasCumplimiento: [
        { cobertura: 'Seriedad De La Oferta', porcentaje: '5%', valorAsegurado: 150000000, estado: 'Activa' },
        { cobertura: 'Cumplimiento', porcentaje: '10%', valorAsegurado: 300000000, estado: 'Activa' },
        { cobertura: 'Calidad Del Servicio', porcentaje: '7%', valorAsegurado: 200000000, estado: 'Activa' }
      ],
      responsabilidadCivil: [
        { cobertura: 'Contratista Y Subcontratista', porcentaje: '15%', valorAsegurado: 500000000, estado: 'Activa' },
        { cobertura: 'Gastos Medicos Persona', porcentaje: '3%', valorAsegurado: 100000000, estado: 'Activa' },
        { cobertura: 'Contaminaci√≥n Accidental', porcentaje: '6%', valorAsegurado: 200000000, estado: 'Activa' }
      ],
      resumenCostos: {
        primaNeta: 2100000,
        iva: 399000,
        primaTotal: 2499000
      }
    },
    {
      id: 'COT-2024-002',
      tipo: 'Cotizaci√≥n',
      numero: 'COT-2024-002',
      tomador: { nombre: 'Servicios DEF S.A.S', documento: '900987654-3' },
      producto: 'Buen Manejo y Correcta Inversi√≥n',
      valorAsegurado: 750000000,
      estado: 'Borrador',
      fechaCreacion: '15/1/2024',
      cupoDisponible: 950000000,
      datosGenerales: {
        numeroContrato: 'CONT-GENERAL-2024-002',
        tipoDocTomador: 'NIT',
        numDocTomador: '900987654-3',
        nombreTomador: 'Servicios DEF S.A.S',
        moneda: 'COP',
        tipoDocAsegurado: 'NIT',
        numDocAsegurado: '900987654-3',
        nombreAsegurado: 'Servicios DEF S.A.S'
      },
      ubicacionRiesgo: {
        departamento: 'Cundinamarca',
        municipio: 'Bogot√°',
        direccion: 'Carrera 15 # 100-20'
      },
      detallesContrato: {
        valorContrato: 750000000,
        fechaInicio: '2024-03-01',
        duracion: '18 meses',
        fechaFin: '2025-09-01'
      },
      coberturasCumplimiento: [
        { cobertura: 'Buen Manejo', porcentaje: '10%', valorAsegurado: 750000000, estado: 'Activa' }
      ],
      responsabilidadCivil: [],
      resumenCostos: {
        primaNeta: 3500000,
        iva: 665000,
        primaTotal: 4165000
      }
    },
    {
      id: 'COT-2024-003',
      tipo: 'Cotizaci√≥n',
      numero: 'COT-2024-003',
      tomador: { nombre: 'Constructora Integral M...', documento: '900444555-8' },
      producto: 'Cumplimiento de Contrato',
      valorAsegurado: 850000000,
      estado: 'Cotizada',
      fechaCreacion: '10/1/2024',
      cupoDisponible: 800000000,
      datosGenerales: {
        numeroContrato: 'CONT-GENERAL-2024-003',
        tipoDocTomador: 'NIT',
        numDocTomador: '900444555-8',
        nombreTomador: 'Constructora Integral Moderna S.A.S',
        moneda: 'COP',
        tipoDocAsegurado: 'NIT',
        numDocAsegurado: '900444555-8',
        nombreAsegurado: 'Constructora Integral Moderna S.A.S'
      },
      ubicacionRiesgo: {
        departamento: 'Valle del Cauca',
        municipio: 'Cali',
        direccion: 'Avenida 6N # 35-25'
      },
      detallesContrato: {
        valorContrato: 850000000,
        fechaInicio: '2024-01-15',
        duracion: '24 meses',
        fechaFin: '2026-01-15'
      },
      coberturasCumplimiento: [
        { cobertura: 'Cumplimiento', porcentaje: '15%', valorAsegurado: 850000000, estado: 'Activa' }
      ],
      responsabilidadCivil: [],
      resumenCostos: {
        primaNeta: 4200000,
        iva: 798000,
        primaTotal: 4998000
      }
    },
    {
      id: 'COT-2024-004',
      tipo: 'Cotizaci√≥n',
      numero: 'COT-2024-004',
      tomador: { nombre: 'Telecomunicaciones PQR...', documento: '900777888-5' },
      producto: 'Seriedad de Oferta',
      valorAsegurado: 450000000,
      estado: 'Cotizada',
      fechaCreacion: '05/1/2024',
      cupoDisponible: 1500000000,
      datosGenerales: {
        numeroContrato: 'CONT-GENERAL-2024-004',
        tipoDocTomador: 'NIT',
        numDocTomador: '900777888-5',
        nombreTomador: 'Telecomunicaciones PQR S.A',
        moneda: 'COP',
        tipoDocAsegurado: 'NIT',
        numDocAsegurado: '900777888-5',
        nombreAsegurado: 'Telecomunicaciones PQR S.A'
      },
      ubicacionRiesgo: {
        departamento: 'Atl√°ntico',
        municipio: 'Barranquilla',
        direccion: 'Calle 72 # 50-10'
      },
      detallesContrato: {
        valorContrato: 450000000,
        fechaInicio: '2024-02-01',
        duracion: '6 meses',
        fechaFin: '2024-08-01'
      },
      coberturasCumplimiento: [
        { cobertura: 'Seriedad de Oferta', porcentaje: '5%', valorAsegurado: 450000000, estado: 'Activa' }
      ],
      responsabilidadCivil: [],
      resumenCostos: {
        primaNeta: 1800000,
        iva: 342000,
        primaTotal: 2142000
      }
    },
    {
      id: 'COT-2024-005',
      tipo: 'Cotizaci√≥n',
      numero: 'COT-2024-005',
      tomador: { nombre: 'Servicios Hospitalarios S...', documento: '900333444-6' },
      producto: 'Calidad del Servicio',
      valorAsegurado: 620000000,
      estado: 'Cotizada',
      fechaCreacion: '02/1/2024',
      cupoDisponible: 1100000000,
      datosGenerales: {
        numeroContrato: 'CONT-GENERAL-2024-005',
        tipoDocTomador: 'NIT',
        numDocTomador: '900333444-6',
        nombreTomador: 'Servicios Hospitalarios del Norte S.A.S',
        moneda: 'COP',
        tipoDocAsegurado: 'NIT',
        numDocAsegurado: '900333444-6',
        nombreAsegurado: 'Servicios Hospitalarios del Norte S.A.S'
      },
      ubicacionRiesgo: {
        departamento: 'Santander',
        municipio: 'Bucaramanga',
        direccion: 'Carrera 27 # 36-45'
      },
      detallesContrato: {
        valorContrato: 620000000,
        fechaInicio: '2024-03-15',
        duracion: '12 meses',
        fechaFin: '2025-03-15'
      },
      coberturasCumplimiento: [
        { cobertura: 'Calidad del Servicio', porcentaje: '8%', valorAsegurado: 620000000, estado: 'Activa' }
      ],
      responsabilidadCivil: [],
      resumenCostos: {
        primaNeta: 2480000,
        iva: 471200,
        primaTotal: 2951200
      }
    }
  ];

  constructor(
    private readonly route: ActivatedRoute,
    private readonly router: Router,
    private readonly breadcrumbService: BreadcrumbService,
    private readonly quoteService: QuoteService,
    private readonly ngZone: NgZone,
    private readonly cdr: ChangeDetectorRef,
  ) {}

  ngOnInit(): void {
    console.log('üöÄ POLICY-INPUT: ngOnInit ejecutado');
    console.log('üîç Estado inicial:', {
      currentStep: this.currentStep,
      isViewDetailsMode: this.isViewDetailsMode,
      selectedAction: this.selectedAction,
    });
    
    // ‚úÖ Inicializar cache del actionLabel
    this.updateCachedActionLabel();
    
    this.setupBreadcrumb();

    // ‚úÖ Obtener par√°metros desde query parameters
    this.route.queryParams.subscribe(params => {
      console.log('üîç POLICY-INPUT: Query params recibidos:', params);
      this.action = (params['action'] as PolicyInputAction) || PolicyInputAction.COTIZAR;
      
      // ‚úÖ Actualizar cache del actionLabel cuando cambia la acci√≥n
      this.updateCachedActionLabel();

      // ‚úÖ Reconfigurar modal SARLAFT seg√∫n la acci√≥n desde query params
      this.sarlaftModal = sarlaftModalConfig(this.action);

      // ‚úÖ Reconfigurar modal "Cliente no creado" seg√∫n la acci√≥n
      this.clienteNoCreadoModal = this.createClienteNoCreadoModalConfig();

      // ‚úÖ Detectar el tipo de acci√≥n
      const isFromModify = params['action'] === 'modificar';
      const isFromViewDetails = params['action'] === 'ver-detalles';
      const itemId = params['id'];
      const targetStep = params['step'];
      const shouldPreload = params['preload'] === 'true';
      const isReadonly = params['readonly'] === 'true';

      console.log('üîç POLICY-INPUT: isFromModify:', isFromModify);
      console.log('üîç POLICY-INPUT: isFromViewDetails:', isFromViewDetails);
      console.log('üîç POLICY-INPUT: itemId:', itemId);
      console.log('üîç POLICY-INPUT: shouldPreload:', shouldPreload);

      if ((isFromModify || isFromViewDetails) && itemId && shouldPreload) {
        const actionLabel = isFromViewDetails ? 'vista de detalles' : 'modificaci√≥n';
        console.log(`üìù Cargando datos para ${actionLabel} desde cotizaci√≥n:`, itemId);

        this.loadDataForModification(itemId, isFromViewDetails, isReadonly);

        // Si viene con step espec√≠fico, ir a ese paso
        if (targetStep) {
          const stepNumber = parseInt(targetStep);
          const stepIndex = stepNumber - 1; // Convertir a √≠ndice base 0

          console.log('üîç POLICY-INPUT: targetStep recibido:', targetStep);
          console.log('üîç POLICY-INPUT: stepNumber parsed:', stepNumber);
          console.log('üîç POLICY-INPUT: stepIndex calculado:', stepIndex);

          this.currentStep = stepIndex;
          this.stepperConfig.activeIndex = this.currentStep;

          console.log('üéØ NAVEGANDO directamente al paso:', stepNumber, '(√≠ndice:', stepIndex, ')');
          console.log('üéØ currentStep despu√©s:', this.currentStep);
          console.log('üéØ stepperConfig.activeIndex despu√©s:', this.stepperConfig.activeIndex);
        } else {
          console.log('‚ö†Ô∏è POLICY-INPUT: No se proporcion√≥ targetStep');
        }
      } else {
        this.resetFormState();
      }
    });

    // ‚úÖ Inicializar step2Form con la tabla de coberturas y eventos
    // Usar setTimeout para asegurar que el componente est√© completamente inicializado
    setTimeout(() => {
      this.updateStep2Form();
    }, 100);

    // ‚úÖ Inicializar con "cotizar" seleccionado por defecto
    this.selectAction('cotizar');

    // ‚úÖ Suscribirse a cambios del formulario del paso 1 para detectar cambios en el producto
    // Usar setTimeout para asegurar que el formulario est√© completamente inicializado
    setTimeout(() => {
      if (this.step1Form?.form) {
        this.step1Form.form.valueChanges.subscribe(() => {
          console.log('üîÑ Formulario paso 1 cambi√≥, verificando grandes beneficiarios...');
          this.checkGrandesBeneficiarios();
        });

        // ‚úÖ Verificar estado inicial tambi√©n
        this.checkGrandesBeneficiarios();
      } else {
        console.error('‚ùå step1Form.form no est√° disponible');
      }
    }, 100);

    // ‚úÖ Inicializar botones del modal SARLAFT
    this.initializeSarlaftModalButtons();
  }

  private setupBreadcrumb(): void {
    this.updateBreadcrumb();
  }

  // ‚úÖ M√©todo para actualizar breadcrumb din√°micamente seg√∫n la acci√≥n seleccionada
  private updateBreadcrumb(): void {
    const breadcrumbItems: BreadcrumbItem[] = [
      {
        label: 'Portal',
        icon: 'fa-solid fa-home',
        routerLink: ['/portal'],
      },
      {
        label: 'Cotizar o Emitir',
        icon: 'fa-solid fa-paper-plane',
        routerLink: ['/product-selection'],
      },
      {
        // ‚úÖ Breadcrumb din√°mico seg√∫n la acci√≥n seleccionada
        label:
          this.selectedAction === 'cotizar'
            ? 'Cotizar Cumplimiento'
            : this.selectedAction === 'emitir'
              ? 'Emitir Cumplimiento'
              : 'Emisi√≥n de P√≥lizas',
        icon: 'fa-solid fa-file-invoice',
      },
    ];

    this.breadcrumbService.setBreadcrumb(breadcrumbItems);
    this.breadcrumbConfig.items = breadcrumbItems.map(item => ({
      label: item.label,
      icon: item.icon,
      routerLink: item.routerLink?.join('/'),
    }));
  }

  // ‚úÖ M√©todo principal para manejar clic en "Siguiente"
  onNextStep(): boolean | void {
    // ‚úÖ Validar si debe mostrar modal SARLAFT antes de avanzar
    if (this.currentStep === 0 && this.shouldShowSarlaftModal()) {
      this.showSarlaftModal();

      // ‚úÖ En modo COTIZAR: Modal informativo, permite avanzar
      if (this.action === PolicyInputAction.COTIZAR) {
        console.log('üìã Modo COTIZAR: Modal SARLAFT informativo, avanzando autom√°ticamente');
        // Avanzar autom√°ticamente despu√©s de mostrar el modal
        setTimeout(() => {
          this.nextStep();
        }, 100);
        return;
      }

      // ‚úÖ En modo EMITIR: Modal bloqueante, no avanza hasta actualizar
      if (this.action === PolicyInputAction.EMITIR) {
        console.log('üìã Modo EMITIR: Modal SARLAFT bloqueante, esperando actualizaci√≥n');
        return; // No avanzar hasta que se actualice
      }
    }

    // AVANZAR AL SIGUIENTE PASO
    this.nextStep();
  }

  // ‚úÖ OBLIGATORIO: Configuraci√≥n del stepper con labels optimizadas para mobile
  stepperConfig: ILibTbStepper = {
    activeIndex: 0,
    readonly: false,
    type: 'number',
    class: 'stepper-responsive', // ‚úÖ Clase personalizada para responsive
    items: [
      {
        label: 'Producto y Contrato',
        icon: 'fa-solid fa-file-contract',
        command: () => this.goToStep(0),
      },
      {
        label: 'Formulario',
        icon: 'fa-solid fa-edit',
        command: () => this.goToStep(1),
      },
      {
        label: 'Confirmaci√≥n',
        icon: 'fa-solid fa-check-circle',
        command: () => this.goToStep(2),
      },
    ],
    libTbActiveIndexChange: (index: number) => {
      this.currentStep = index;
    },
  };

  // ‚úÖ OBLIGATORIO: Un formulario din√°mico por paso
  step1Form: ILibTbDynamicForm = step1PolicyInfoForm();
  step2Form: ILibTbDynamicForm = step2ContractInfoForm(undefined, undefined, false);

  // ‚úÖ OBLIGATORIO: Botones de navegaci√≥n usando propiedades nativas de tech-block-lib
  btnNext: ILibTbButton = {
    label: 'Siguiente',
    icon: 'fa-solid fa-arrow-right',
    iconPosition: 'right',
    styleBtn: 'fill',
    typeBtn: 'primary',
    libTbClick: () => this.onNextStep(),
  };

  btnPrevious: ILibTbButton = {
    label: 'Anterior',
    icon: 'fa-solid fa-arrow-left',
    iconPosition: 'left',
    styleBtn: 'stroke',
    typeBtn: 'secondary',
    libTbClick: () => this.previousStep(),
  };

  btnSubmit: ILibTbButton = {
    label: this.getActionLabel().submitLabel,
    icon: 'fa-solid fa-paper-plane',
    iconPosition: 'right',
    styleBtn: 'fill',
    typeBtn: 'primary',
    libTbClick: () => this.submitForm(),
  };

  // ‚úÖ Botones para el paso 3 - Din√°micos seg√∫n la acci√≥n
  get btnConfirmAndIssue(): ILibTbButton {
    console.log(
      'üîç DEBUG: btnConfirmAndIssue getter llamado, selectedAction:',
      this.selectedAction,
      'loading:',
      this.loading,
    );
    return {
      label: this.selectedAction === 'cotizar' ? 'Generar Cotizaci√≥n' : 'Confirmar y Emitir P√≥liza',
      icon: this.selectedAction === 'cotizar' ? 'fa-solid fa-calculator' : 'fa-solid fa-check-circle',
      iconPosition: 'left',
      styleBtn: 'fill',
      typeBtn: 'primary',
      loading: this.loading,
      disabled: this.loading,
      libTbClick: () => {
        console.log('üî• BOT√ìN CLICK DETECTADO! selectedAction:', this.selectedAction);
        if (this.selectedAction === 'cotizar') {
          console.log('üî• LLAMANDO onGenerateQuote()');
          this.onGenerateQuote();
        } else {
          console.log('üî• LLAMANDO confirmAndIssuePolicy()');
          this.confirmAndIssuePolicy();
        }
      },
    };
  }

  btnQuoteBusiness: ILibTbButton = {
    label: 'Quiero Emitir',
    icon: 'fa-solid fa-calculator',
    iconPosition: 'left',
    styleBtn: 'fill',
    typeBtn: 'secondary',
    libTbClick: () => this.quoteBusiness(),
  };

  // ‚úÖ Bot√≥n para volver a management desde vista de detalles
  btnBackToManagement: ILibTbButton = {
    label: 'Volver a Cotizaciones',
    icon: 'fa-solid fa-arrow-left',
    iconPosition: 'left',
    styleBtn: 'stroke',
    typeBtn: 'secondary',
    libTbClick: () => this.backToManagement(),
  };

  // ‚úÖ Botones para las opciones de Emitir
  btnElegirCotizacion: ILibTbButton = {
    label: 'Elegir cotizaci√≥n',
    icon: 'fa-solid fa-search',
    iconPosition: 'left',
    styleBtn: 'fill',
    typeBtn: 'secondary',
    class: 'w-full',
    libTbClick: () => this.selectEmitirOption('cotizacion-existente'),
  };

  btnCrearNuevaEmision: ILibTbButton = {
    label: 'Crear nueva emisi√≥n',
    icon: 'fa-solid fa-plus',
    iconPosition: 'left',
    styleBtn: 'fill',
    typeBtn: 'primary',
    class: 'w-full',
    libTbClick: () => this.selectEmitirOption('poliza-nueva'),
  };

  // ‚úÖ Botones para el resumen de cotizaci√≥n
  btnBackToForm: ILibTbButton = {
    label: 'Volver',
    icon: 'fa-solid fa-arrow-left',
    iconPosition: 'left',
    styleBtn: 'stroke',
    typeBtn: 'secondary',
    libTbClick: () => this.backToForm(),
  };

  btnGenerateEmission: ILibTbButton = {
    label: 'Generar Emisi√≥n',
    icon: 'fa-solid fa-file-export',
    iconPosition: 'right',
    styleBtn: 'fill',
    typeBtn: 'primary',
    loading: this.loading,
    disabled: this.loading,
    libTbClick: () => this.generateEmissionFromSummary(),
  };

  // ‚úÖ Bot√≥n adicional para el contenedor como en imagen 2
  btnUsarCotizacionExistente: ILibTbButton = {
    label: 'Usar cotizaci√≥n existente',
    icon: 'fa-solid fa-file-search',
    iconPosition: 'left',
    styleBtn: 'fill',
    typeBtn: 'secondary',
    class: 'min-w-[200px]',
    libTbClick: () => this.usarCotizacionExistente(),
  };

  // ‚úÖ Configuraci√≥n del FileUploadField de tech-block-lib - Ajustada para PDF, Word y Excel
  fileUploadConfig: ILibTbFileUploadField = {
    dataQaId: 'contract-file-upload',
    multiple: false,
    dragDropLabel: 'Seleccionar archivo',
    dragDropIcon: 'fa-solid fa-upload', // ‚úÖ Icono de upload como en imagen 1
    caption: 'Peso m√°ximo por cada archivo: 10 MB. Formatos permitidos: PDF, Word, Excel.',
    avaibleTypes: [
      'application/pdf', // PDF
      'application/msword', // DOC
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX
      'application/vnd.ms-excel', // XLS
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // XLSX
    ],
    maxSize: 10485760, // 10MB en bytes
    errorText: {
      type: 'Tipo de archivo no v√°lido. Use PDF, Word o Excel.',
      maxSize: 'El archivo es demasiado grande. M√°ximo 10MB.',
      length: 'Solo se permite un archivo a la vez.',
    },
    customAlert: {
      position: 'top-center',
      preventDuplicates: true,
    },
    customUploadingFile: {
      textCaption: {
        uploading: 'Subiendo archivo...',
        uploaded: 'Archivo cargado correctamente',
        error: 'Error al cargar el archivo',
      },
      iconCaption: {
        uploadingIcon: 'fa-solid fa-spinner fa-spin',
        uploadedIcon: 'fa-solid fa-check-circle',
        errorIcon: 'fa-solid fa-exclamation-triangle',
      },
    },
    libTbOnCatchFile: (files: File[]) => this.onFileCaught(files),
    libTbOnDeleteFile: (file: File) => this.onFileDeleted(file),
    libTbOnReloadFile: uploadingFile => this.onFileReload(uploadingFile),
  };

  // ‚úÖ Datos originales de coberturas (para restaurar valores)
  private readonly coberturasOriginales = [
    {
      id: 1,
      seleccionado: false,
      cobertura: '401-Seriedad De La Oferta',
      porcentajeAsegurado: 10,
      valorAsegurado: 15000000,
      fechaInicio: '2025-05-05',
      fechaVencimiento: '2025-11-05',
      tiempoAdicional: 30,
      prima: 150000,
    },
    {
      id: 2,
      seleccionado: false,
      cobertura: '402-Manejo Del Anticipo',
      porcentajeAsegurado: 50,
      valorAsegurado: 75000000,
      fechaInicio: '2025-05-05',
      fechaVencimiento: '2026-05-04',
      tiempoAdicional: 60,
      prima: 750000,
    },
    {
      id: 3,
      seleccionado: true, // ‚úÖ Solo esta est√° seleccionada seg√∫n imagen 2
      cobertura: '403-Cumplimiento',
      porcentajeAsegurado: 20,
      valorAsegurado: 30000000,
      fechaInicio: '2025-05-05',
      fechaVencimiento: '2026-05-04',
      tiempoAdicional: 45,
      prima: 300000,
    },
    {
      id: 4,
      seleccionado: false,
      cobertura: '404-Salarios Y Prestaciones S',
      porcentajeAsegurado: 20,
      valorAsegurado: 30000000,
      fechaInicio: '2025-05-05',
      fechaVencimiento: '2026-05-04',
      tiempoAdicional: 45,
      prima: 300000,
    },
    {
      id: 5,
      seleccionado: false,
      cobertura: '405-Estabilidad De La Obra',
      porcentajeAsegurado: 30,
      valorAsegurado: 45000000,
      fechaInicio: '2026-05-05',
      fechaVencimiento: '2031-05-04',
      tiempoAdicional: 90,
      prima: 450000,
    },
    {
      id: 6,
      seleccionado: false,
      cobertura: '406-Calidad Del Servicio',
      porcentajeAsegurado: 25,
      valorAsegurado: 37500000,
      fechaInicio: '2026-05-05',
      fechaVencimiento: '2027-05-04',
      tiempoAdicional: 60,
      prima: 375000,
    },
    {
      id: 7,
      seleccionado: false,
      cobertura: '407-Buen Funcionamiento De Lo',
      porcentajeAsegurado: 15,
      valorAsegurado: 22500000,
      fechaInicio: '2026-05-05',
      fechaVencimiento: '2027-05-04',
      tiempoAdicional: 45,
      prima: 225000,
    },
    {
      id: 8,
      seleccionado: false,
      cobertura: '411-Suministro De Repuestos',
      porcentajeAsegurado: 10,
      valorAsegurado: 15000000,
      fechaInicio: '2026-05-05',
      fechaVencimiento: '2027-05-04',
      tiempoAdicional: 30,
      prima: 150000,
    },
    {
      id: 9,
      seleccionado: false,
      cobertura: '412-Calidad De Los Bienes Sum',
      porcentajeAsegurado: 10,
      valorAsegurado: 15000000,
      fechaInicio: '2026-05-05',
      fechaVencimiento: '2027-05-04',
      tiempoAdicional: 30,
      prima: 150000,
    },
    {
      id: 10,
      seleccionado: false,
      cobertura: '413-Pago Anticipado',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      fechaInicio: '2025-05-05',
      fechaVencimiento: '2026-05-04',
      tiempoAdicional: 120,
      prima: 1500000,
    },
  ];

  // ‚úÖ Datos originales de coberturas RC (para restaurar valores)
  private readonly rcCoberturasOriginales = [
    {
      id: 1,
      seleccionado: false,
      cobertura: '224-Patronal Persona',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 1.85,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 2,
      seleccionado: true,
      cobertura: '225-Patronal Vigencia',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 1.95,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 3,
      seleccionado: true,
      cobertura: '226-Contratista Y Subcontratista',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 2.15,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 4,
      seleccionado: true,
      cobertura: '227-Gastos Medicos Persona',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 1.75,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 5,
      seleccionado: true,
      cobertura: '228-Gastos M√©dicos Vigencia',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 1.85,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 6,
      seleccionado: true,
      cobertura: '232-Contaminaci√≥n Accidental',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 2.45,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 7,
      seleccionado: true,
      cobertura: '237-Cruzada',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 2.25,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 8,
      seleccionado: true,
      cobertura: '238-Bienes Bajo Cuidado Tene',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 1.95,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 9,
      seleccionado: true,
      cobertura: '244-Veh√≠.Propios Y No Vehic.',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 2.35,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
    {
      id: 10,
      seleccionado: true,
      cobertura: '245-Vehi.Propios Y No Vigen.',
      porcentajeAsegurado: 100,
      valorAsegurado: 150000000,
      tasa: 2.45,
      fechaInicio: '2024-08-01',
      fechaVencimiento: '2025-07-31',
    },
  ];

  // ‚úÖ Configuraci√≥n de la tabla de coberturas de cumplimiento
  coberturasTable: ILibTbTable = {
    dataQaId: 'coberturas-cumplimiento-table',
    value: JSON.parse(JSON.stringify(this.coberturasOriginales)), // ‚úÖ Copia profunda para evitar referencias
    paginator: true,
    rows: 10,
    rowsPerPageOptions: [5, 10, 15, 20],
    sortMode: 'single',
    selectionMode: 'multiple',
    dataKey: 'id',
    class: 'coberturas__table bg-grayscaleWhite',
    responsive: true,
    responsiveLayout: 'scroll',
    filterLocale: 'es',
    libTbOnRowSelect: (event: any) => this.onCoberturaSelect(event),
    libTbOnRowUnselect: (event: any) => this.onCoberturaUnselect(event),
    libTbSelectionChange: (event: any) => this.onCoberturaSelectionChange(event),
  };

  // ‚úÖ Configuraci√≥n de la tabla de coberturas RC
  rcCoberturasTable: ILibTbTable = {
    dataQaId: 'rc-coberturas-table',
    value: JSON.parse(JSON.stringify(this.rcCoberturasOriginales)), // ‚úÖ Copia profunda para evitar referencias
    paginator: true,
    rows: 10,
    rowsPerPageOptions: [5, 10, 15, 20],
    sortMode: 'single',
    selectionMode: 'multiple',
    dataKey: 'id',
    class: 'rc-coberturas__table bg-grayscaleWhite',
    responsive: true,
    responsiveLayout: 'scroll',
    filterLocale: 'es',
    libTbOnRowSelect: (event: any) => this.onRcCoberturaSelect(event),
    libTbOnRowUnselect: (event: any) => this.onRcCoberturaUnselect(event),
    libTbSelectionChange: (event: any) => this.onRcCoberturaSelectionChange(event),
  };

  // ‚úÖ Configuraci√≥n de tabla de resumen de coberturas de cumplimiento
  complianceSummaryTable: ILibTbTable = {
    dataQaId: 'compliance-summary-table',
    value: [], // Se llenar√° din√°micamente con las coberturas seleccionadas
    paginator: false, // Sin paginaci√≥n para el resumen
    class: 'compliance-summary__table bg-grayscaleL400',
    responsive: true,
    responsiveLayout: 'scroll',
    filterLocale: 'es',
  };

  // ‚úÖ Configuraci√≥n de tabla de resumen de coberturas RC
  rcSummaryTable: ILibTbTable = {
    dataQaId: 'rc-summary-table',
    value: [], // Se llenar√° din√°micamente con las coberturas seleccionadas
    paginator: false, // Sin paginaci√≥n para el resumen
    class: 'rc-summary__table bg-grayscaleL400',
    responsive: true,
    responsiveLayout: 'scroll',
    filterLocale: 'es',
  };

  btnProcessContract: ILibTbButton = {
    label: 'Procesar Contrato (Simulado)',
    icon: 'fa-solid fa-robot',
    iconPosition: 'left',
    styleBtn: 'fill',
    typeBtn: 'secondary',
    loading: this.isProcessing,
    libTbClick: () => this.simulateContractProcessing(),
  };

  // ‚úÖ OBLIGATORIO: M√©todos de navegaci√≥n
  goToStep(step: number): void {
    if (step > this.currentStep && !this.validateCurrentStep()) {
      return; // No permitir avanzar sin validar
    }
    this.currentStep = step;
    this.stepperConfig.activeIndex = step;

    // ‚úÖ Actualizar tablas de resumen cuando se navega al paso 3
    if (step === 2) {
      this.updateSummaryTables();
    }
  }

  // ‚úÖ Validar archivo de contrato antes de continuar
  validateContractFile(): boolean {
    if (this.isContractFileRequired && !this.fileName && !this.selectedFileName) {
      this.contractFileError = true;
      return false;
    }
    this.contractFileError = false;
    return true;
  }

  // ‚úÖ M√©todos para manejo de archivos
  triggerFileInput(): void {
    const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement;
    if (fileInput) {
      fileInput.click();
    }
  }

  onFileSelected(event: Event): void {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files.length > 0) {
      this.selectedFile = input.files[0];
      this.contractFileError = false;
      
      // Simular upload con progreso
      this.isUploading = true;
      this.uploadProgress = 0;
      
      const interval = setInterval(() => {
        this.uploadProgress += 10;
        if (this.uploadProgress >= 100) {
          clearInterval(interval);
          this.isUploading = false;
          this.selectedFileName = this.selectedFile!.name;
          this.fileName = this.selectedFile!.name;
          console.log('‚úÖ Archivo subido:', this.selectedFileName);
        }
      }, 150);
    }
  }

  removeFile(): void {
    this.selectedFile = null;
    this.selectedFileName = null;
    this.fileName = null;
    this.uploadProgress = 0;
    console.log('üóëÔ∏è Archivo removido');
  }

  cancelUpload(): void {
    this.isUploading = false;
    this.selectedFile = null;
    this.selectedFileName = null;
    this.uploadProgress = 0;
    console.log('‚ùå Carga cancelada');
  }

  addContract(): void {
    this.formSubmitted = true;
    
    // Validar campos obligatorios
    let isValid = true;
    
    if (!this.tipoProducto) isValid = false;
    if (!this.claveIntermediario) isValid = false;
    
    // Si es Grandes Beneficiarios, validar campos adicionales (sin programaSeleccionado)
    if (this.tipoProducto === 'grandes-beneficiarios') {
      if (!this.programaParametrizado) isValid = false;
      if (!this.tipoDocumentoTomador) isValid = false;
      if (!this.numeroDocumentoTomador) isValid = false;
      if (!this.tipoDocumentoAsegurado) isValid = false;
      if (!this.numeroDocumentoAsegurado) isValid = false;
    }
    
    if (!this.selectedFileName) {
      this.contractFileError = true;
      isValid = false;
    }
    
    if (!isValid) {
      console.log('‚ùå Formulario inv√°lido - campos obligatorios faltantes');
      return;
    }
    
    console.log('üìÑ Contrato agregado:', {
      tipoProducto: this.tipoProducto,
      claveIntermediario: this.claveIntermediario,
      archivo: this.selectedFileName,
      tipoDocumentoAsegurado: this.tipoDocumentoAsegurado,
      numeroDocumentoAsegurado: this.numeroDocumentoAsegurado,
      tipoDocumentoTomador: this.tipoDocumentoTomador,
      numeroDocumentoTomador: this.numeroDocumentoTomador
    });
  }

  // ‚úÖ M√©todo para manejar cambio de tipo de producto
  onTipoProductoChange(value: string): void {
    console.log('üìã Tipo de producto cambiado a:', value);
    // Limpiar campos adicionales si cambia el tipo
    if (value !== 'grandes-beneficiarios') {
      this.tipoDocumentoAsegurado = '';
      this.numeroDocumentoAsegurado = '';
      this.tipoDocumentoTomador = '';
      this.numeroDocumentoTomador = '';
      this.programaParametrizado = '';
      this.programaSeleccionado = '';
    }
  }

  // ‚úÖ M√©todo para manejar cambio de clave del intermediario
  onClaveIntermediarioChange(value: string): void {
    console.log('üîë Clave del intermediario cambiada a:', value);
    // Buscar si la clave existe en la lista predefinida
    const intermediarioEncontrado = this.clavesIntermediario.find(c => c.codigo === value);
    if (intermediarioEncontrado) {
      this.nombreIntermediario = intermediarioEncontrado.nombre;
      console.log('‚úÖ Intermediario encontrado:', intermediarioEncontrado.nombre);
    } else if (value && value.length >= 3) {
      // Si no est√° en la lista pero tiene al menos 3 caracteres, simular b√∫squeda
      this.nombreIntermediario = `Intermediario Manual - Clave: ${value}`;
      console.log('üìù Clave manual ingresada:', value);
    } else {
      this.nombreIntermediario = '';
    }
  }

  // ‚úÖ M√©todo para abrir ayuda
  // ‚úÖ M√©todo para manejar cambio de fecha en calendario
  onFechaChange(tipo: string, fecha: string): void {
    console.log(`üìÖ Fecha ${tipo} cambiada a:`, fecha);
    switch(tipo) {
      case 'inicio':
        this.fechaInicioContrato = fecha;
        break;
      case 'fin':
        this.fechaFinContrato = fecha;
        break;
      case 'inicioRC':
        this.fechaInicioRC = fecha;
        break;
      case 'finRC':
        this.fechaFinRC = fecha;
        break;
    }
  }

  openHelp(): void {
    console.log('üìû Abriendo ayuda...');
    // Aqu√≠ se puede implementar un modal de ayuda o abrir un chat
  }

  // ‚úÖ M√©todos para el modal de √©xito
  closeSuccessModal(): void {
    this.showSuccessModal = false;
  }

  acceptSuccessModal(): void {
    this.showSuccessModal = false;
    // El paso ya se cambi√≥, solo cerramos el modal
  }

  nextStep(): void {
    console.log('üîÑ nextStep ejecutado. Estado actual:', {
      currentStep: this.currentStep,
      maxSteps: this.stepperConfig.items!.length - 1,
    });

    // ‚úÖ Validar campos obligatorios en el paso 1
    if (this.currentStep === 0) {
      // Validar archivo de contrato
      if (!this.selectedFileName) {
        this.contractFileError = true;
        console.log('‚ùå Archivo de contrato requerido');
        return;
      }
      
      // Si es Grandes Beneficiarios, validar campos adicionales
      if (this.tipoProducto === 'grandes-beneficiarios') {
        if (!this.claveIntermediario || !this.programaParametrizado || 
            !this.tipoDocumentoTomador || !this.numeroDocumentoTomador || 
            !this.tipoDocumentoAsegurado || !this.numeroDocumentoAsegurado) {
          console.log('‚ùå Campos obligatorios faltantes para Grandes Beneficiarios:', {
            claveIntermediario: this.claveIntermediario,
            programaParametrizado: this.programaParametrizado,
            tipoDocumentoTomador: this.tipoDocumentoTomador,
            numeroDocumentoTomador: this.numeroDocumentoTomador,
            tipoDocumentoAsegurado: this.tipoDocumentoAsegurado,
            numeroDocumentoAsegurado: this.numeroDocumentoAsegurado
          });
          return;
        }
      }
      
      // Mostrar modal de √©xito al pasar al paso 2
      this.showSuccessModal = true;
      
      // Simular procesamiento autom√°tico
      this.simulateContractProcessing();
    }

    // Avanzar al siguiente paso
    if (this.currentStep < this.stepperConfig.items!.length - 1) {
      this.currentStep++;
      this.stepperConfig.activeIndex = this.currentStep;

      console.log('‚úÖ Paso avanzado. Nuevo currentStep:', this.currentStep);

      // ‚úÖ Verificar grandes beneficiarios al cambiar al paso 2
      if (this.currentStep === 1) {
        console.log('üîÑ Cambiando al paso 2, verificando grandes beneficiarios...');
        this.checkGrandesBeneficiarios();
      }

      // ‚úÖ Actualizar tablas de resumen cuando se avanza al paso 3
      if (this.currentStep === 2) {
        console.log('üìä Actualizando tablas de resumen para paso 3');
        this.updateSummaryTables();
      }
    } else {
      console.log('‚ùå No se puede avanzar. Raz√≥n:', {
        isMaxStep: this.currentStep >= this.stepperConfig.items!.length - 1,
      });
    }
  }

  previousStep(): void {
    if (this.currentStep > 0) {
      this.currentStep--;
      this.stepperConfig.activeIndex = this.currentStep;
    }
  }

  validateCurrentStep(): boolean {
    const currentForm = this.getCurrentStepForm();
    currentForm.libTbCallSubmit?.();
    return currentForm.form?.valid ?? false;
  }

  private getCurrentStepForm(): ILibTbDynamicForm {
    switch (this.currentStep) {
      case 0:
        return this.step1Form;
      case 1:
        return this.step2Form;
      default:
        return this.step1Form;
    }
  }

  submitForm(): void {
    // Validar todos los pasos antes del env√≠o final
    const allValid = this.stepperConfig.items!.every((_, index) => {
      if (index < 2) {
        // Solo validar pasos con formularios (0 y 1)
        const prevStep = this.currentStep;
        this.currentStep = index;
        const isValid = this.validateCurrentStep();
        this.currentStep = prevStep;
        return isValid;
      }
      return true;
    });

    if (allValid) {
      // Combinar datos de todos los formularios
      const allData = {
        ...this.step1Form.form?.value,
        ...this.step2Form.form?.value,
      };
      console.log('Formulario completo:', allData);

      // Mostrar mensaje seg√∫n la acci√≥n
      const actionLabel = this.getActionLabel();
      alert(`${actionLabel.successMessage}\n\nDatos: ${JSON.stringify(allData, null, 2)}`);

      // Navegar de vuelta al dashboard
      this.router.navigate(['/dashboard']);
    } else {
      alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios antes de continuar.');
    }
  }

  // ‚úÖ Simulaci√≥n de procesamiento de contrato
  simulateContractProcessing(): void {
    this.isProcessing = true;
    this.btnProcessContract.loading = true;

    // Simular delay de procesamiento
    setTimeout(() => {
      // Llenar formulario del paso 2 con datos simulados
      this.step2Form.form?.patchValue(MOCK_EXTRACTED_CONTRACT_DATA);
      this.step2Data = MOCK_EXTRACTED_CONTRACT_DATA;

      this.isProcessing = false;
      this.btnProcessContract.loading = false;
      this.fileName = 'contrato-ejemplo.pdf';

      alert(
        '‚úÖ Procesamiento completado exitosamente!\nLa informaci√≥n del contrato ha sido cargada autom√°ticamente en el formulario.',
      );
    }, 2000);
  }

  // ‚úÖ M√©todos auxiliares para el template
  get isFirstStep(): boolean {
    return this.currentStep === 0;
  }

  get isLastStep(): boolean {
    return this.currentStep === this.stepperConfig.items!.length - 1;
  }

  get isConfirmationStep(): boolean {
    return this.currentStep === 2;
  }

  // ‚úÖ M√©todo privado para actualizar el cache del actionLabel
  private updateCachedActionLabel(): void {
    this._cachedIsMobile = window.innerWidth <= 768;
    this._cachedActionLabel = this._cachedIsMobile ? ACTION_LABELS_MOBILE[this.action] : ACTION_LABELS[this.action];
  }

  // ‚úÖ M√©todo que retorna labels optimizados seg√∫n el tama√±o de pantalla (usa cache)
  getActionLabel(): ActionLabel {
    return this._cachedActionLabel;
  }

  // ‚úÖ M√©todo para obtener el t√≠tulo din√°mico seg√∫n el paso actual (usa cache)
  getCurrentStepTitle(): string {
    switch (this.currentStep) {
      case 0:
        return this._cachedActionLabel.step1Title;
      case 1:
        return this._cachedActionLabel.step2Title;
      case 2:
        return this._cachedActionLabel.step3Title;
      default:
        return this._cachedActionLabel.step1Title;
    }
  }

  // ‚úÖ M√©todo para obtener la descripci√≥n din√°mica seg√∫n el paso actual (usa cache)
  getCurrentStepDescription(): string {
    switch (this.currentStep) {
      case 0:
        return this._cachedActionLabel.step1Description;
      case 1:
        return this._cachedActionLabel.step2Description;
      case 2:
        return this._cachedActionLabel.step3Description;
      default:
        return this._cachedActionLabel.step1Description;
    }
  }

  // ‚úÖ M√©todo auxiliar para detectar mobile (usa cache)
  get isMobile(): boolean {
    return this._cachedIsMobile;
  }

  // ‚úÖ Listener para cambios de tama√±o de ventana (actualiza cache)
  @HostListener('window:resize')
  onResize(): void {
    // ‚úÖ Actualizar cache cuando cambia el tama√±o de pantalla
    this.updateCachedActionLabel();
    this.cdr.detectChanges();
  }

  private resetFormState(): void {
    this.currentStep = 0;
    this.stepperConfig.activeIndex = 0;
    this.fileName = null;
    this.isProcessing = false;
    this.step2Data = INITIAL_STEP2_DATA;

    // ‚úÖ RESETEAR estado del formulario
    this.isFormEnabled = false;
    this.selectedAction = null;
    this.selectedEmitirOption = null;

    // Actualizar label del bot√≥n submit seg√∫n la acci√≥n
    this.btnSubmit.label = this.getActionLabel().submitLabel;
  }

  // ‚úÖ Getters para datos de confirmaci√≥n
  get step1Data(): Record<string, unknown> {
    return this.step1Form.form?.value || {};
  }

  get step2FormData(): Record<string, unknown> {
    return this.step2Form.form?.value || {};
  }

  // ‚úÖ M√©todos de manejo de archivos usando tech-block-lib
  onFileCaught(files: File[]): void {
    if (files.length > 0) {
      this.fileName = files[0].name;
      this.contractFileError = false; // ‚úÖ Limpiar error cuando se carga un archivo
      console.log('Archivo seleccionado:', files[0]);
    }
  }

  onFileDeleted(file: File): void {
    this.fileName = null;
    this.contractFileError = true; // ‚úÖ Marcar error cuando se elimina el archivo
    console.log('Archivo eliminado:', file);
  }

  onFileReload(uploadingFile: any): void {
    console.log('Recargando archivo:', uploadingFile);
  }

  // ‚úÖ M√©todos para manejar eventos de la tabla de coberturas
  onCoberturaSelect(event: any): void {
    console.log('Cobertura seleccionada:', event);
  }

  onCoberturaUnselect(event: any): void {
    console.log('Cobertura deseleccionada:', event);
  }

  onCoberturaSelectionChange(event: any): void {
    console.log('Cambio en selecci√≥n de coberturas:', event);
  }

  // ‚úÖ M√©todos para los botones de acci√≥n de la tabla
  clearCoberturasSelection(): void {
    // ‚úÖ Limpiar selecci√≥n y restaurar valores originales
    if (this.coberturasTable.value) {
      this.coberturasTable.value.forEach(cobertura => {
        if (cobertura.seleccionado) {
          cobertura.seleccionado = false;
          this.restoreOriginalValues(cobertura);
        }
      });
    }

    this.coberturasTable.selection = [];
    this.coberturasTable.editingRowKeys = {};
    console.log('Selecci√≥n de coberturas limpiada y valores restaurados');
  }

  refreshCoberturas(): void {
    // ‚úÖ Actualizar datos de coberturas
    console.log('Actualizando coberturas...');
    // Aqu√≠ se har√≠a la llamada al backend para refrescar datos
  }

  // ‚úÖ M√©todo para manejar cambio de checkbox de cobertura
  onCoberturaCheckboxChange(cobertura: any, event: any): void {
    const wasSelected = cobertura.seleccionado;
    cobertura.seleccionado = event.target.checked;

    if (wasSelected && !cobertura.seleccionado) {
      // ‚úÖ Si se deseleccion√≥, restaurar valores originales
      this.restoreOriginalValues(cobertura);
    }

    console.log('Cobertura seleccionada/deseleccionada:', cobertura);
  }

  // ‚úÖ Restaurar valores originales de una cobertura
  private restoreOriginalValues(cobertura: any): void {
    const original = this.coberturasOriginales.find(c => c.id === cobertura.id);
    if (original) {
      cobertura.porcentajeAsegurado = original.porcentajeAsegurado;
      cobertura.valorAsegurado = original.valorAsegurado;
      cobertura.fechaInicio = original.fechaInicio;
      cobertura.fechaVencimiento = original.fechaVencimiento;
      cobertura.tiempoAdicional = original.tiempoAdicional;
      cobertura.prima = original.prima;
      console.log('Valores restaurados para cobertura:', cobertura.cobertura);
    }
  }

  // ‚úÖ M√©todos para manejar cambios en campos editables
  onPorcentajeChange(cobertura: any, event: any): void {
    const newValue = parseInt(event.target.value) || 0;
    cobertura.porcentajeAsegurado = Math.min(Math.max(newValue, 0), 100); // Limitar entre 0-100
    console.log('Porcentaje actualizado:', cobertura.porcentajeAsegurado);
  }

  onValorAseguradoChange(cobertura: any, event: any): void {
    const newValue = parseInt(event.target.value) || 0;
    cobertura.valorAsegurado = Math.max(newValue, 0); // No permitir valores negativos
    console.log('Valor asegurado actualizado:', cobertura.valorAsegurado);
  }

  onTasaChange(cobertura: any, event: any): void {
    const newValue = parseFloat(event.target.value) || 0;
    cobertura.tasa = Math.max(newValue, 0); // No permitir valores negativos
    console.log('Tasa actualizada:', cobertura.tasa);
  }

  onFechaInicioChange(cobertura: any, event: any): void {
    cobertura.fechaInicio = event.target.value;
    console.log('Fecha inicio actualizada:', cobertura.fechaInicio);
  }

  onFechaVencimientoChange(cobertura: any, event: any): void {
    cobertura.fechaVencimiento = event.target.value;
    console.log('Fecha vencimiento actualizada:', cobertura.fechaVencimiento);
  }

  onTiempoAdicionalChange(cobertura: any, event: any): void {
    cobertura.tiempoAdicional = parseInt(event.target.value) || 0;
    console.log('Tiempo adicional actualizado:', cobertura.tiempoAdicional);
  }

  onPrimaChange(cobertura: any, event: any): void {
    cobertura.prima = parseFloat(event.target.value) || 0;
    console.log('Prima actualizada:', cobertura.prima);
  }

  // ‚úÖ Guardar cambios de coberturas editadas
  saveCoberturasChanges(): void {
    if (!this.coberturasTable.value) {
      console.log('No hay datos de coberturas disponibles');
      return;
    }

    const coberturasEditadas = this.coberturasTable.value.filter(c => c.seleccionado);

    if (coberturasEditadas.length > 0) {
      console.log('Guardando cambios de coberturas:', coberturasEditadas);
      // ‚úÖ Aqu√≠ se har√≠a la llamada al backend para guardar los cambios
      // Por ahora solo simulamos el guardado
      alert(
        `‚úÖ Se guardaron exitosamente los cambios de ${coberturasEditadas.length} cobertura(s) de cumplimiento.`,
      );
    } else {
      console.log('No hay coberturas seleccionadas para guardar');
    }
  }

  // ‚úÖ M√©todos para coberturas RC
  onRcCoberturaSelect(event: any): void {
    console.log('Cobertura RC seleccionada:', event);
  }

  onRcCoberturaUnselect(event: any): void {
    console.log('Cobertura RC deseleccionada:', event);
  }

  onRcCoberturaSelectionChange(event: any): void {
    console.log('Cambio en selecci√≥n de coberturas RC:', event);
  }

  // ‚úÖ M√©todo para manejar cambio de checkbox de cobertura RC
  onRcCoberturaCheckboxChange(cobertura: any, event: any): void {
    const wasSelected = cobertura.seleccionado;
    cobertura.seleccionado = event.target.checked;

    if (wasSelected && !cobertura.seleccionado) {
      // ‚úÖ Si se deseleccion√≥, restaurar valores originales
      this.restoreRcOriginalValues(cobertura);
    }

    console.log('Cobertura RC seleccionada/deseleccionada:', cobertura);
  }

  // ‚úÖ Restaurar valores originales de una cobertura RC
  private restoreRcOriginalValues(cobertura: any): void {
    const original = this.rcCoberturasOriginales.find(c => c.id === cobertura.id);
    if (original) {
      cobertura.porcentajeAsegurado = original.porcentajeAsegurado;
      cobertura.valorAsegurado = original.valorAsegurado;
      cobertura.tasa = original.tasa;
      cobertura.fechaInicio = original.fechaInicio;
      cobertura.fechaVencimiento = original.fechaVencimiento;
      console.log('Valores restaurados para cobertura RC:', cobertura.cobertura);
    }
  }

  // ‚úÖ M√©todos para manejar cambios en campos editables RC
  onRcPorcentajeChange(cobertura: any, event: any): void {
    const newValue = parseInt(event.target.value) || 0;
    cobertura.porcentajeAsegurado = Math.min(Math.max(newValue, 0), 100); // Limitar entre 0-100
    console.log('Porcentaje RC actualizado:', cobertura.porcentajeAsegurado);
  }

  onRcValorAseguradoChange(cobertura: any, event: any): void {
    const newValue = parseInt(event.target.value) || 0;
    cobertura.valorAsegurado = Math.max(newValue, 0); // No permitir valores negativos
    console.log('Valor asegurado RC actualizado:', cobertura.valorAsegurado);
  }

  onRcTasaChange(cobertura: any, event: any): void {
    const newValue = parseFloat(event.target.value) || 0;
    cobertura.tasa = Math.max(newValue, 0); // No permitir valores negativos
    console.log('Tasa RC actualizada:', cobertura.tasa);
  }

  onRcFechaInicioChange(cobertura: any, event: any): void {
    cobertura.fechaInicio = event.target.value;
    console.log('Fecha inicio RC actualizada:', cobertura.fechaInicio);
  }

  onRcFechaVencimientoChange(cobertura: any, event: any): void {
    cobertura.fechaVencimiento = event.target.value;
    console.log('Fecha vencimiento RC actualizada:', cobertura.fechaVencimiento);
  }

  // ‚úÖ M√©todos para los botones de acci√≥n de la tabla RC
  clearRcCoberturasSelection(): void {
    // ‚úÖ Limpiar selecci√≥n y restaurar valores originales
    if (this.rcCoberturasTable.value) {
      this.rcCoberturasTable.value.forEach(cobertura => {
        if (cobertura.seleccionado) {
          cobertura.seleccionado = false;
          this.restoreRcOriginalValues(cobertura);
        }
      });
    }

    // ‚úÖ Limpiar selecciones de la tabla tech-block
    if (this.rcCoberturasTable.selection) {
      this.rcCoberturasTable.selection = [];
    }
    if (this.rcCoberturasTable.editingRowKeys) {
      this.rcCoberturasTable.editingRowKeys = {};
    }
    console.log('Selecci√≥n de coberturas RC limpiada y valores restaurados');
  }

  refreshRcCoberturas(): void {
    // ‚úÖ Recargar datos de coberturas RC
    this.rcCoberturasTable.value = JSON.parse(JSON.stringify(this.rcCoberturasOriginales));
    console.log('Coberturas RC actualizadas');
  }

  // ‚úÖ Guardar cambios de coberturas RC editadas
  saveRcCoberturasChanges(): void {
    if (!this.rcCoberturasTable.value) {
      console.log('No hay datos de coberturas RC disponibles');
      return;
    }

    const coberturasEditadas = this.rcCoberturasTable.value.filter(c => c.seleccionado);

    if (coberturasEditadas.length > 0) {
      console.log('Guardando cambios de coberturas RC:', coberturasEditadas);
      // ‚úÖ Aqu√≠ se har√≠a la llamada al backend para guardar los cambios
      // Por ahora solo simulamos el guardado
      alert(
        `‚úÖ Se guardaron exitosamente los cambios de ${coberturasEditadas.length} cobertura(s) de responsabilidad civil.`,
      );
    } else {
      console.log('No hay coberturas RC seleccionadas para guardar');
    }
  }

  // ‚úÖ M√©todo para toggle del acorde√≥n RC (HTML nativo)
  toggleRcAccordion(): void {
    this.rcAccordionOpen = !this.rcAccordionOpen;
    console.log('Acorde√≥n RC:', this.rcAccordionOpen ? 'expandido' : 'contra√≠do');
  }

  // ‚úÖ M√©todo para habilitar/deshabilitar toda la secci√≥n RC con comportamiento de acorde√≥n
  onRcSectionToggle(event: any): void {
    this.isRcSectionEnabled = event.target.checked;

    if (!this.isRcSectionEnabled) {
      // ‚úÖ Si se deshabilita la secci√≥n, contraer el acorde√≥n y limpiar selecciones
      this.rcAccordionTab.selected = false; // Contraer tab del acorde√≥n
      this.rcAccordionTab.disabled = true; // Deshabilitar tab
      this.rcAccordionConfig.activeIndex = -1; // Contraer todo el acorde√≥n
      this.rcAccordionOpen = false;
      this.clearRcCoberturasSelection();
      console.log('Secci√≥n RC deshabilitada - acorde√≥n contra√≠do y selecciones limpiadas');
    } else {
      // ‚úÖ Si se habilita la secci√≥n, expandir el acorde√≥n
      this.rcAccordionTab.selected = true; // Expandir tab del acorde√≥n
      this.rcAccordionTab.disabled = false; // Habilitar tab
      this.rcAccordionConfig.activeIndex = 0; // Expandir primer tab
      this.rcAccordionOpen = true;
      console.log('Secci√≥n RC habilitada - acorde√≥n expandido');
    }
  }

  // ‚úÖ M√©todos para el paso 3
  quoteBusiness(): void {
    console.log('üöÄ M√âTODO EJECUTADO: quoteBusiness - Mostrando resumen de cotizaci√≥n');

    // ‚úÖ Generar datos de la cotizaci√≥n
    this.quoteSummaryData = this.generateQuoteSummaryData();

    // ‚úÖ Mostrar vista de resumen de cotizaci√≥n
    this.showQuoteSummary = true;
  }

  // ‚úÖ M√©todos para c√°lculos de costos
  getPrimaNeta(): string {
    const prima = this.quoteSummaryData?.premium || 0;
    return `$ ${prima.toLocaleString()}`;
  }

  getIVA(): string {
    const prima = this.quoteSummaryData?.premium || 0;
    const iva = Math.round(prima * 0.19);
    return `$ ${iva.toLocaleString()}`;
  }

  getPrimaTotal(): string {
    const prima = this.quoteSummaryData?.premium || 0;
    const total = Math.round(prima * 1.19);
    return `$ ${total.toLocaleString()}`;
  }

  // ‚úÖ M√©todo para generar datos del resumen de cotizaci√≥n
  private generateQuoteSummaryData(): any {
    const quoteNumber = `COT-${Date.now().toString().slice(-6)}`;

    const quoteData = {
      quoteNumber: quoteNumber,
      status: 'Cotizada',
      creationDate: '19/9/2025',
      product: 'Producto por defecto',
      policyType: 'Civil',
      insuredValue: 620000000,
      availableCredit: 2480000000,
      contractNumber: 'CONT-GENERAL-2024-001',
      documentType: 'CC',
      clientName: 'Cliente Demo',
      clientDocument: '12345678',
      currency: 'COP',
      insuredDocumentType: 'CC',
      insuredDocumentNumber: '12345678',
      insuredName: 'Cliente Demo',
      // ‚úÖ Informaci√≥n adicional de la cotizaci√≥n
      coverage: 'General',
      premium: Math.round(620000000 * 0.05), // 5% del valor asegurado
      validity: '12 meses',
      startDate: new Date().toLocaleDateString('es-CO'),
      endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toLocaleDateString('es-CO'),

      // ‚úÖ Ubicaci√≥n del Riesgo
      department: 'Cundinamarca',
      localityMunicipality: 'Bogot√° D.C.',
      riskAddress: 'Calle 100 # 15-20, Bogot√° D.C.',

      // ‚úÖ Detalles del Contrato
      contractValue: 620000000,
      contractStartDate: '01/01/2024',
      contractDuration: 12,
      contractEndDate: '31/12/2024',
      // ‚úÖ Coberturas seleccionadas
      selectedCoverages: [
        { id: '226', name: 'Contratista Y Subcontratista', value: 500000000, selected: true },
        { id: '227', name: 'Gastos Medicos Persona', value: 100000000, selected: true },
        { id: '232', name: 'Contaminaci√≥n Accidental', value: 20000000, selected: true },
      ],
      // ‚úÖ Coberturas aceptadas para cumplimiento (imagen 1) - 3 coberturas seleccionadas
      complianceCoverages: [
        {
          id: '401',
          name: 'Seriedad De La Oferta',
          value: 150000000,
          percentage: 5,
          status: 'Activa',
          accepted: true,
        },
        {
          id: '403',
          name: 'Cumplimiento',
          value: 300000000,
          percentage: 10,
          status: 'Activa',
          accepted: true,
        },
        {
          id: '406',
          name: 'Calidad Del Servicio',
          value: 200000000,
          percentage: 7,
          status: 'Activa',
          accepted: true,
        },
      ],
      // ‚úÖ Coberturas RC (imagen 2) - 3 coberturas seleccionadas
      rcCoverages: [
        {
          id: '226',
          name: 'Contratista Y Subcontratista',
          value: 500000000,
          percentage: 15,
          status: 'Activa',
          accepted: true,
        },
        {
          id: '227',
          name: 'Gastos Medicos Persona',
          value: 100000000,
          percentage: 3,
          status: 'Activa',
          accepted: true,
        },
        {
          id: '232',
          name: 'Contaminaci√≥n Accidental',
          value: 200000000,
          percentage: 6,
          status: 'Activa',
          accepted: true,
        },
      ],
    };

    console.log('üîç DEBUG: Datos de cotizaci√≥n generados:', quoteData);
    console.log('üîç DEBUG: Coberturas seleccionadas:', quoteData.selectedCoverages);
    console.log('üîç DEBUG: Coberturas de cumplimiento:', quoteData.complianceCoverages);
    console.log('üîç DEBUG: Coberturas RC:', quoteData.rcCoverages);

    return quoteData;
  }

  // ‚úÖ M√©todo para generar emisi√≥n desde el resumen
  generateEmissionFromSummary(): void {
    console.log('üöÄ M√âTODO EJECUTADO: generateEmissionFromSummary');

    this.loading = true;

    // ‚úÖ Simular proceso de emisi√≥n
    setTimeout(() => {
      this.loading = false;

      // ‚úÖ Mostrar notificaci√≥n de √©xito
      this.showSuccessNotification(
        `¬°Emisi√≥n generada exitosamente! P√≥liza ${this.quoteSummaryData.quoteNumber} emitida.`,
      );

      // ‚úÖ Ocultar la vista de resumen
      this.showQuoteSummary = false;
      this.quoteSummaryData = null;
    }, 2000);
  }

  // ‚úÖ M√©todo para volver al formulario desde el resumen
  backToForm(): void {
    console.log('üîô Volviendo al formulario desde resumen');
    this.showQuoteSummary = false;
    this.quoteSummaryData = null;
  }

  // ‚úÖ M√©todo para "Quiero Emitir" - bot√≥n del paso 3 (abre modal Resumen de Cotizaci√≥n)
  onQuieroEmitir(): void {
    console.log('üìã Quiero Emitir clicked - Abriendo modal de Resumen de Cotizaci√≥n');
    this.showQuoteSummary = true;
    this.quoteSummaryData = {
      quoteNumber: 'COT-311551',
      status: 'Cotizada',
      creationDate: '19/9/2025',
      product: 'Producto por defecto',
      insuredValue: 620000000,
      availableCredit: 2480000000,
      contractNumber: 'CONT-GENERAL-2024-001',
      documentType: 'CC',
      clientName: 'Cliente Demo',
      clientDocument: '12345678',
      currency: 'COP',
      insuredDocumentType: 'CC',
      insuredDocumentNumber: '12345678',
      insuredName: 'Cliente Demo',
      department: 'Cundinamarca',
      municipality: 'Bogot√° D.C.',
      riskAddress: 'Calle 100 # 15-20, Bogot√° D.C.',
      contractValue: 620000000,
      contractStartDate: '01/01/2024',
      contractDuration: '12 meses',
      contractEndDate: '31/12/2024',
      coberturasCumplimiento: [
        { cobertura: 'Seriedad De La Oferta', porcentaje: '5%', valorAsegurado: 150000000, estado: 'Activa' },
        { cobertura: 'Cumplimiento', porcentaje: '10%', valorAsegurado: 300000000, estado: 'Activa' },
        { cobertura: 'Calidad Del Servicio', porcentaje: '7%', valorAsegurado: 200000000, estado: 'Activa' },
      ],
      rcCoverages: [
        { name: 'Contratista Y Subcontratista', percentage: 15, value: 500000000, status: 'Activa' },
        { name: 'Gastos Medicos Persona', percentage: 3, value: 100000000, status: 'Activa' },
        { name: 'Contaminaci√≥n Accidental', percentage: 6, value: 200000000, status: 'Activa' },
      ],
    };
  }
  
  // ‚úÖ M√©todo para cerrar el modal de Resumen de Cotizaci√≥n
  closeQuoteSummary(): void {
    this.showQuoteSummary = false;
  }
  
  // ‚úÖ M√©todo para "Generar Emisi√≥n" desde el modal
  onGenerarEmision(): void {
    console.log('üöÄ Generar Emisi√≥n clicked');
    this.showQuoteSummary = false;
    this.showSuccessToast = true;
    this.successToastMessage = '¬°Emisi√≥n generada exitosamente! P√≥liza COT-311551 emitida.';
    
    // Ocultar el toast despu√©s de 5 segundos
    setTimeout(() => {
      this.showSuccessToast = false;
    }, 5000);
  }

  // ‚úÖ M√©todo para "Generar Cotizaci√≥n" - bot√≥n del paso 3 (muestra toast de √©xito)
  onGenerarCotizacion(): void {
    console.log('üìä Generar Cotizaci√≥n clicked - Mostrando toast de √©xito');
    this.showSuccessToast = true;
    this.successToastMessage = 'Su cotizaci√≥n qued√≥ generada correctamente';
    
    // Ocultar el toast despu√©s de 5 segundos
    setTimeout(() => {
      this.showSuccessToast = false;
    }, 5000);
  }
  
  // ‚úÖ Propiedad para el toast de √©xito
  showSuccessToast = false;
  successToastMessage = '';

  // ‚úÖ M√©todo para generar cotizaci√≥n usando EXCLUSIVAMENTE TechBlock
  async onGenerateQuote(): Promise<void> {
    console.log('üöÄ M√âTODO EJECUTADO: onGenerateQuote - TechBlock Implementation');

    this.loading = true;
    console.log('üîç DEBUG: loading establecido a true');

    try {
      // ‚úÖ Obtener datos del formulario actual
      const formData = this.getCurrentFormData();

      // ‚úÖ Llamar al servicio de cotizaci√≥n
      const result$ = this.quoteService.generateQuote(formData);
      const result = await firstValueFrom(result$);

      console.log('‚úÖ Cotizaci√≥n generada exitosamente:', result);

      // ‚úÖ Mostrar notificaci√≥n de √©xito usando TechBlock Snackbar
      this.ngZone.run(() => {
        this.showSuccessNotification('Su cotizaci√≥n qued√≥ generada correctamente');
      });
    } catch (error) {
      console.error('‚ùå Error generando cotizaci√≥n:', error);

      // ‚úÖ Mostrar notificaci√≥n de error usando TechBlock Snackbar
      this.ngZone.run(() => {
        this.showErrorNotification('No se pudo generar la cotizaci√≥n. Int√©ntalo de nuevo.');
      });
    } finally {
      this.loading = false;
      console.log('üîç DEBUG: loading establecido a false');
    }
  }

  // ‚úÖ M√©todo para generar n√∫mero de cotizaci√≥n
  generateQuoteNumber(): string {
    const timestamp = Date.now();
    const randomSuffix = Math.floor(Math.random() * 1000)
      .toString()
      .padStart(3, '0');
    return `COT-${timestamp.toString().slice(-6)}-${randomSuffix}`;
  }

  // ‚úÖ M√©todo para actualizar el formulario del paso 2
  updateStep2Form(): void {
    this.step2Form = step2ContractInfoForm(
      this.coberturasTable,
      {
        onCoberturaSelect: (event: any) => this.onCoberturaSelect(event),
        onCoberturaSelectionChange: (event: any) => this.onCoberturaSelectionChange(event),
        onPorcentajeChange: (data: { cobertura: any; event: any }) =>
          this.onPorcentajeChange(data.cobertura, data.event),
        onValorAseguradoChange: (data: { cobertura: any; event: any }) =>
          this.onValorAseguradoChange(data.cobertura, data.event),
        onTasaChange: (data: { cobertura: any; event: any }) =>
          this.onTasaChange(data.cobertura, data.event),
        onFechaInicioChange: (data: { cobertura: any; event: any }) =>
          this.onFechaInicioChange(data.cobertura, data.event),
        onFechaVencimientoChange: (data: { cobertura: any; event: any }) =>
          this.onFechaVencimientoChange(data.cobertura, data.event),
        onTiempoAdicionalChange: (data: { cobertura: any; event: any }) =>
          this.onTiempoAdicionalChange(data.cobertura, data.event),
        onPrimaChange: (data: { cobertura: any; event: any }) =>
          this.onPrimaChange(data.cobertura, data.event),
        onCheckboxChange: (data: { cobertura: any; event: any }) =>
          this.onCoberturaCheckboxChange(data.cobertura, data.event),
        onClearSelection: () => this.clearCoberturasSelection(),
        onRefreshCoberturas: () => this.refreshCoberturas(),
        onSaveChanges: () => this.saveCoberturasChanges(),
      },
      this.showGrandesBeneficiarios,
    );
  }

  // ‚úÖ M√©todo para verificar si se debe mostrar la secci√≥n de grandes beneficiarios
  checkGrandesBeneficiarios(): void {
    const formData = this.step1Form?.form?.value || {};
    const selectedProduct = formData.insuranceProduct;
    const newShowGrandesBeneficiarios = selectedProduct === 'grandes-beneficiarios';

    console.log('üîç checkGrandesBeneficiarios:', {
      formData,
      selectedProduct,
      newShowGrandesBeneficiarios,
      currentShowGrandesBeneficiarios: this.showGrandesBeneficiarios,
    });

    // Solo actualizar si el estado cambi√≥
    if (this.showGrandesBeneficiarios !== newShowGrandesBeneficiarios) {
      console.log('üîÑ Actualizando showGrandesBeneficiarios:', newShowGrandesBeneficiarios);
      this.showGrandesBeneficiarios = newShowGrandesBeneficiarios;
      this.updateStep2Form();
    } else {
      console.log('‚ÑπÔ∏è No hay cambios en showGrandesBeneficiarios');
    }
  }

  // ‚úÖ NUEVO: M√©todo para mostrar modal "Cliente no creado"
  showClienteNoCreadoModal(): void {
    console.log('üö® Mostrando modal "Cliente no creado"');
    // ‚úÖ Reconfigurar modal antes de mostrarlo para asegurar configuraci√≥n correcta
    this.clienteNoCreadoModal = this.createClienteNoCreadoModalConfig();
    this.clienteNoCreadoModal.visible = true;
  }

  // ‚úÖ NUEVO: M√©todo para crear configuraci√≥n del modal "Cliente no creado" din√°micamente
  private createClienteNoCreadoModalConfig(): ILibTbModal {
    const isEmitirMode = this.action === PolicyInputAction.EMITIR;

    return {
      title: 'Cliente no creado',
      visible: false,
      size: 'medium',
      closable: !isEmitirMode, // ‚úÖ No se puede cerrar en modo EMITIR (bloqueante)
      closeOnEscape: !isEmitirMode, // ‚úÖ No se puede cerrar con ESC en modo EMITIR
      dismissableMask: !isEmitirMode, // ‚úÖ No se puede cerrar clickeando fuera en modo EMITIR
      class: 'cliente-no-creado-modal',
      containerClass: 'cliente-no-creado-modal-container',
      contentStyleClass: 'cliente-no-creado-modal-content',
      baseZIndex: 1000,
      autoZIndex: true,
      focusOnShow: true,
      focusTrap: true,
      closeIcon: isEmitirMode ? undefined : 'fa-solid fa-times', // ‚úÖ Sin bot√≥n X en modo EMITIR
      primaryButton: {
        label: isEmitirMode ? 'Crear' : 'Continuar',
        icon: isEmitirMode ? 'fa-solid fa-user-plus' : 'fa-solid fa-arrow-right',
        iconPosition: 'right',
        styleBtn: 'fill',
        typeBtn: isEmitirMode ? 'primary' : 'secondary',
        class: isEmitirMode
          ? 'cliente-no-creado-modal__button--create'
          : 'cliente-no-creado-modal__button--continue',
        libTbClick: () => this.continueAfterClienteNoCreado(),
      },
      secondaryButton: isEmitirMode
        ? {
            label: 'Cancelar',
            icon: 'fa-solid fa-times',
            iconPosition: 'left',
            styleBtn: 'stroke',
            typeBtn: 'secondary',
            class: 'cliente-no-creado-modal__button--cancel',
            libTbClick: () => this.cancelClienteNoCreado(),
          }
        : undefined, // ‚úÖ Sin bot√≥n secundario en modo COTIZAR
      libTbOnShow: () => {
        console.log(
          `Modal "Cliente no creado" mostrado en modo ${isEmitirMode ? 'EMITIR (bloqueante)' : 'COTIZAR (no bloqueante)'}`,
        );
      },
      libTbOnHide: () => {
        console.log('Modal "Cliente no creado" ocultado');
      },
    };
  }

  // ‚úÖ NUEVO: M√©todo para continuar despu√©s del modal "Cliente no creado"
  continueAfterClienteNoCreado(): void {
    console.log('‚úÖ Continuando despu√©s del modal "Cliente no creado"');
    this.clienteNoCreadoModal.visible = false;

    // Continuar con el flujo normal del nextStep
    this.simulateContractProcessing();
    this.currentStep++;
    this.stepperConfig.activeIndex = this.currentStep;

    console.log('‚úÖ Paso avanzado despu√©s del modal. Nuevo currentStep:', this.currentStep);

    // ‚úÖ Verificar grandes beneficiarios al cambiar al paso 2
    if (this.currentStep === 1) {
      console.log('üîÑ Cambiando al paso 2, verificando grandes beneficiarios...');
      this.checkGrandesBeneficiarios();
    }
  }

  // ‚úÖ NUEVO: M√©todo para cancelar en modo EMITIR
  cancelClienteNoCreado(): void {
    console.log('‚ùå Cancelando creaci√≥n de cliente en modo EMITIR');
    this.clienteNoCreadoModal.visible = false;
    // En modo EMITIR, cancelar podr√≠a redirigir al dashboard o mostrar mensaje
    // Por ahora solo cierra el modal
  }

  // ‚úÖ M√©todo para obtener datos del formulario actual
  private getCurrentFormData(): any {
    // Obtener datos del formulario din√°mico actual
    const formData = this.step1Form?.form?.value || {};

    return {
      product: formData.producto || 'Producto por defecto',
      contractValue: formData.valorContrato || 0,
      clientData: {
        nombre: formData.nombre || '',
        email: formData.email || '',
        telefono: formData.telefono || '',
      },
      step2Data: this.step2Data,
      action: this.selectedAction,
    };
  }

  // ‚úÖ M√©todo para mostrar notificaci√≥n de √©xito usando TechBlock Snackbar
  private showSuccessNotification(message: string): void {
    console.log('üéâ Mostrando notificaci√≥n de √©xito:', message);

    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: `‚úÖ ${message}`,
      class: 'snackbar-success-theme',
    };
  }

  // ‚úÖ M√©todo para mostrar notificaci√≥n de error usando TechBlock Snackbar
  private showErrorNotification(message: string): void {
    console.log('‚ùå Mostrando notificaci√≥n de error:', message);

    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: `‚ùå ${message}`,
      class: 'snackbar-error-theme',
    };
  }

  confirmAndIssuePolicy(): void {
    console.log('üöÄ M√âTODO EJECUTADO: confirmAndIssuePolicy');

    // ‚úÖ Prueba simple primero
    alert('¬°Bot√≥n funcionando! M√©todo confirmAndIssuePolicy ejecutado correctamente.');

    // ‚úÖ Mostrar notificaci√≥n de √©xito usando TechBlock Snackbar
    this.showSuccessNotification('¬°P√≥liza Emitida Exitosamente!');

    // ‚úÖ Navegar a management despu√©s de un delay
    setTimeout(() => {
      this.router.navigate(['/management']);
    }, 2000);
  }

  backToManagement(): void {
    console.log('üîô Volviendo a la pantalla de management');
    this.router.navigate(['/management']);
  }

  // ‚úÖ Actualizar tablas de resumen cuando se navega al paso 3
  private updateSummaryTables(): void {
    // ‚úÖ Actualizar tabla de coberturas de cumplimiento seleccionadas
    if (this.coberturasTable.value) {
      const coberturasSeleccionadas = this.coberturasTable.value.filter(c => c.seleccionado);
      this.complianceSummaryTable.value = coberturasSeleccionadas;
    }

    // ‚úÖ Actualizar tabla de coberturas RC seleccionadas
    if (this.rcCoberturasTable.value) {
      const rcCoberturasSeleccionadas = this.rcCoberturasTable.value.filter(c => c.seleccionado);
      this.rcSummaryTable.value = rcCoberturasSeleccionadas;
    }
  }

  // ‚úÖ Cargar datos para modificaci√≥n o vista de detalles desde management
  private loadDataForModification(itemId: string, isViewDetails = false, isReadonly = false): void {
    console.log('üîç Buscando item con ID:', itemId);

    // Buscar el item en los datos de management
    const item = MOCK_MANAGEMENT_DATA.find(data => data.id === itemId);

    if (item) {
      console.log('‚úÖ Item encontrado para precarga:', item);

      // Precargar datos en step2Form
      this.preloadStep2Data(item);

      // Establecer el modo de vista de detalles
      this.isViewDetailsMode = isViewDetails;

      // Actualizar breadcrumb seg√∫n el tipo de acci√≥n
      if (isViewDetails) {
        this.updateBreadcrumbForViewDetails(item);
      } else {
        this.updateBreadcrumbForModification(item);
      }

      // Si es solo lectura, deshabilitar formularios (implementar despu√©s si es necesario)
      if (isReadonly) {
        console.log('üìÑ Modo solo lectura activado');
        // TODO: Implementar l√≥gica para deshabilitar formularios si es necesario
      }
    } else {
      console.error('‚ùå No se encontr√≥ el item con ID:', itemId);
    }
  }

  // ‚úÖ Precargar datos del item en el paso 2
  private preloadStep2Data(item: IPolicyManagementItem): void {
    console.log('üìã Precargando datos en formulario paso 2...');

    // Simular timeout para esperar que el formulario est√© listo
    setTimeout(() => {
      if (this.step2Form.form) {
        // Precargar datos del item en el formulario
        this.step2Form.form.patchValue({
          // Datos generales
          numeroContratoGeneral: item.numeroContrato ?? 'CONT-2024-001',
          nombreTomadorGeneral: item.tomador,
          numeroDocumentoTomadorGeneral: item.numeroDocumento,
          tipoDocumentoTomadorGeneral: 'NIT',
          nombreAseguradoGeneral: item.tomador, // Por defecto mismo que tomador
          numeroDocumentoAseguradoGeneral: item.numeroDocumento,
          tipoDocumentoAseguradoGeneral: 'NIT',
          moneda: 'COP',

          // Ubicaci√≥n (datos simulados)
          departamento: 'Bogot√° D.C.',
          localidadMunicipio: 'Bogot√°',
          direccionRiesgo: 'Calle 100 # 10-20, Bogot√°',

          // Detalles del contrato
          valorContrato: item.valorAsegurado,
          fechaInicioContrato: '2024-02-01',
          duracionContrato: '12',
          fechaFinContrato: '2025-02-01',
        });

        console.log('‚úÖ Datos precargados exitosamente en formulario paso 2');
      } else {
        console.error('‚ùå Formulario paso 2 no est√° disponible para precargar');
      }
    }, 100);
  }

  // ‚úÖ Actualizar breadcrumb para indicar modificaci√≥n
  private updateBreadcrumbForModification(item: IPolicyManagementItem): void {
    const breadcrumbItems: BreadcrumbItem[] = [
      {
        label: 'Portal',
        icon: 'fa-solid fa-home',
        routerLink: ['/portal'],
      },
      {
        label: 'Retomar Cotizaci√≥n',
        icon: 'fa-solid fa-file-alt',
        routerLink: ['/management'],
      },
      {
        label: `Modificar ${item.numero}`,
        icon: 'fa-solid fa-edit',
      },
    ];

    this.breadcrumbService.setBreadcrumb(breadcrumbItems);
    this.breadcrumbConfig.items = breadcrumbItems.map(breadcrumbItem => ({
      label: breadcrumbItem.label,
      icon: breadcrumbItem.icon,
      routerLink: breadcrumbItem.routerLink,
    }));
  }

  // ‚úÖ Actualizar breadcrumb para vista de detalles
  private updateBreadcrumbForViewDetails(item: IPolicyManagementItem): void {
    const breadcrumbItems: BreadcrumbItem[] = [
      {
        label: 'Portal',
        icon: 'fa-solid fa-home',
        routerLink: ['/portal'],
      },
      {
        label: 'Retomar Cotizaci√≥n',
        icon: 'fa-solid fa-file-alt',
        routerLink: ['/management'],
      },
      {
        label: `Detalles ${item.numero}`,
        icon: 'fa-solid fa-eye',
      },
    ];

    this.breadcrumbService.setBreadcrumb(breadcrumbItems);
    this.breadcrumbConfig.items = breadcrumbItems.map(breadcrumbItem => ({
      label: breadcrumbItem.label,
      icon: breadcrumbItem.icon,
      routerLink: breadcrumbItem.routerLink,
    }));
  }

  // ‚úÖ M√©todo para seleccionar acci√≥n (Cotizar o Emitir)
  selectAction(action: 'cotizar' | 'emitir'): void {
    console.log('üéØ Acci√≥n seleccionada:', action);
    this.selectedAction = action;

    // ‚úÖ HABILITAR FORMULARIO despu√©s de seleccionar acci√≥n
    this.isFormEnabled = true;

    // ‚úÖ ACTUALIZAR BREADCRUMB din√°micamente seg√∫n la acci√≥n seleccionada
    this.updateBreadcrumb();

    // ‚úÖ LIMPIAR ERRORES cuando se cambia de acci√≥n (la p√°gina se recarga)
    this.contractFileError = false;
    this.fileName = null; // Limpiar archivo cargado

    // ‚úÖ RESETEAR FORMULARIOS DIN√ÅMICOS para limpiar campos en rojo
    this.step1Form.form?.reset();
    this.step2Form.form?.reset();

    // Actualizar la acci√≥n en el componente
    if (action === 'cotizar') {
      this.action = PolicyInputAction.COTIZAR;
    } else {
      this.action = PolicyInputAction.EMITIR;
    }
    
    // ‚úÖ Actualizar cache del actionLabel cuando cambia la acci√≥n
    this.updateCachedActionLabel();

    // ‚úÖ Reconfigurar modal SARLAFT seg√∫n la nueva acci√≥n
    this.sarlaftModal = sarlaftModalConfig(this.action);
    this.initializeSarlaftModalButtons();

    console.log('üìã Acci√≥n actualizada a:', this.action);
    console.log('‚úÖ Formulario habilitado:', this.isFormEnabled);
    console.log('üßπ Errores limpiados al cambiar acci√≥n');
    console.log('üîÑ Formularios din√°micos reseteados');
    console.log('üîÑ Modal SARLAFT reconfigurado para modo:', this.action);
  }

  // ‚úÖ M√©todo para seleccionar opci√≥n de Emitir
  selectEmitirOption(option: 'cotizacion-existente' | 'poliza-nueva'): void {
    console.log('üìã Opci√≥n de emisi√≥n seleccionada:', option);
    this.selectedEmitirOption = option;

    // ‚úÖ LIMPIAR ERRORES cuando se cambia de opci√≥n de emisi√≥n
    this.contractFileError = false;
    this.fileName = null; // Limpiar archivo cargado

    // ‚úÖ RESETEAR FORMULARIOS DIN√ÅMICOS para limpiar campos en rojo
    this.step1Form.form?.reset();
    this.step2Form.form?.reset();

    if (option === 'cotizacion-existente') {
      // ‚úÖ Mostrar tabla de cotizaciones existentes (como versi√≥n 15)
      console.log('üîç Mostrando tabla de cotizaciones existentes...');
      this.showCotizacionesTable = true;
      this.showCotizacionDetalle = false;
      this.cotizacionSeleccionada = null;
      // Forzar detecci√≥n de cambios
      this.cdr.detectChanges();
      console.log('‚úÖ showCotizacionesTable =', this.showCotizacionesTable);
    } else if (option === 'poliza-nueva') {
      // Continuar con el flujo del formulario actual desde el paso 1
      console.log('‚ûï Iniciando proceso de nueva p√≥liza desde paso 1...');

      // Ocultar las opciones de selecci√≥n y mostrar el formulario
      this.selectedAction = 'emitir'; // Mantener emitir seleccionado
      this.selectedEmitirOption = 'poliza-nueva';

      // ‚úÖ Asegurar que el formulario est√© habilitado
      this.isFormEnabled = true;

      // ‚úÖ ACTUALIZAR BREADCRUMB din√°micamente para "Emitir Cumplimiento"
      this.updateBreadcrumb();

      // Asegurar que empezamos desde el paso 1
      this.currentStep = 0;
      this.stepperConfig.activeIndex = 0;

      // Actualizar la acci√≥n para que los labels sean de emisi√≥n
      this.action = PolicyInputAction.EMITIR;
      
      // ‚úÖ Actualizar cache del actionLabel cuando cambia la acci√≥n
      this.updateCachedActionLabel();

      console.log('‚úÖ Formulario configurado para emisi√≥n desde paso 1');
      console.log('‚úÖ Formulario habilitado:', this.isFormEnabled);
    }
  }

  // ‚úÖ M√©todo para bot√≥n "Usar cotizaci√≥n existente" del contenedor adicional
  usarCotizacionExistente(): void {
    console.log('üîç POLICY-INPUT: Navegando a cotizaciones existentes desde contenedor adicional');
    this.router.navigate(['/management'], {
      queryParams: {
        source: 'policy-input-additional',
        action: 'emitir',
      },
    });
  }

  // ‚úÖ M√©todos para botones nativos de las tarjetas de Emitir
  onElegirCotizacion(): void {
    console.log('üîç onElegirCotizacion() EJECUT√ÅNDOSE');
    console.log('üîç Estado ANTES:', {
      showCotizacionesTable: this.showCotizacionesTable,
      showCotizacionDetalle: this.showCotizacionDetalle,
      selectedEmitirOption: this.selectedEmitirOption
    });
    
    // Establecer valores directamente
    this.showCotizacionesTable = true;
    this.showCotizacionDetalle = false;
    this.cotizacionSeleccionada = null;
    this.selectedEmitirOption = 'cotizacion-existente';
    
    console.log('üîç Estado DESPU√âS:', {
      showCotizacionesTable: this.showCotizacionesTable,
      showCotizacionDetalle: this.showCotizacionDetalle,
      selectedEmitirOption: this.selectedEmitirOption
    });
    
    // Forzar actualizaci√≥n
    this.cdr.markForCheck();
    this.cdr.detectChanges();
    
    console.log('‚úÖ Vista de cotizaciones DEBER√çA estar activada');
  }

  onCrearNuevaEmision(): void {
    console.log('‚ûï Crear nueva emisi√≥n - iniciando flujo');
    this.selectEmitirOption('poliza-nueva');
  }

  onUsarCotizacionExistente(): void {
    console.log('üîç Usar cotizaci√≥n existente desde formulario');
    // Mostrar la tabla de cotizaciones directamente
    this.showCotizacionesTable = true;
    this.showCotizacionDetalle = false;
    this.cotizacionSeleccionada = null;
    this.selectedEmitirOption = 'cotizacion-existente';
    // Forzar detecci√≥n de cambios
    this.cdr.detectChanges();
    console.log('‚úÖ showCotizacionesTable =', this.showCotizacionesTable);
  }

  // ‚úÖ Ver detalle de cotizaci√≥n (clic en ojo)
  verDetalleCotizacion(cotizacion: any): void {
    console.log('üëÅ Ver detalle de cotizaci√≥n:', cotizacion.id);
    this.cotizacionSeleccionada = cotizacion;
    this.showCotizacionDetalle = true;
    this.showCotizacionesTable = false;
  }

  // ‚úÖ Modificar cotizaci√≥n (clic en l√°piz) - lleva al Paso 2 con datos precargados
  modificarCotizacion(cotizacion: any): void {
    console.log('‚úèÔ∏è Modificar cotizaci√≥n:', cotizacion.id);
    this.cotizacionSeleccionada = cotizacion;
    
    // Ocultar vistas de cotizaciones
    this.showCotizacionesTable = false;
    this.showCotizacionDetalle = false;
    
    // Habilitar formulario y precargar datos
    this.isFormEnabled = true;
    this.selectedEmitirOption = 'poliza-nueva';
    
    // Precargar datos en step2Data usando las propiedades correctas de IPolicyStep2Data
    this.step2Data = {
      ...this.step2Data,
      numeroContratoGeneral: cotizacion.datosGenerales.numeroContrato,
      numeroContrato: cotizacion.datosGenerales.numeroContrato,
      tipoDocumentoTomadorGeneral: cotizacion.datosGenerales.tipoDocTomador,
      numeroDocumentoTomadorGeneral: cotizacion.datosGenerales.numDocTomador,
      numeroDocumentoTomador: cotizacion.datosGenerales.numDocTomador,
      nombreTomadorGeneral: cotizacion.datosGenerales.nombreTomador,
      nombreTomador: cotizacion.datosGenerales.nombreTomador,
      tipoDocumentoAseguradoGeneral: cotizacion.datosGenerales.tipoDocAsegurado,
      numeroDocumentoAseguradoGeneral: cotizacion.datosGenerales.numDocAsegurado,
      nombreAseguradoGeneral: cotizacion.datosGenerales.nombreAsegurado,
      moneda: cotizacion.datosGenerales.moneda,
      departamento: cotizacion.ubicacionRiesgo.departamento,
      localidadMunicipio: cotizacion.ubicacionRiesgo.municipio,
      direccionRiesgo: cotizacion.ubicacionRiesgo.direccion,
      valorContrato: cotizacion.detallesContrato.valorContrato,
      fechaInicioContrato: cotizacion.detallesContrato.fechaInicio,
      fechaFinContrato: cotizacion.detallesContrato.fechaFin,
      duracionContrato: cotizacion.detallesContrato.duracion
    };
    
    // Ir al paso 2 (Formulario)
    this.currentStep = 1;
    this.stepperConfig.activeIndex = 1;
    
    console.log('‚úÖ Datos precargados para modificaci√≥n:', this.step2Data);
  }

  // ‚úÖ Volver a la lista de cotizaciones desde el detalle
  volverACotizaciones(): void {
    console.log('‚¨ÖÔ∏è Volver a lista de cotizaciones');
    this.showCotizacionDetalle = false;
    this.showCotizacionesTable = true;
    this.cotizacionSeleccionada = null;
  }

  // ‚úÖ Emitir p√≥liza desde la tabla de cotizaciones
  emitirPolizaDesdeTabla(): void {
    if (this.cotizacionSeleccionada) {
      console.log('üìÑ Emitir p√≥liza desde cotizaci√≥n:', this.cotizacionSeleccionada.id);
      this.modificarCotizacion(this.cotizacionSeleccionada);
    } else {
      console.warn('‚ö†Ô∏è Seleccione una cotizaci√≥n primero');
      alert('Seleccione una cotizaci√≥n primero');
    }
  }

  // ‚úÖ Seleccionar cotizaci√≥n en la tabla (radio button)
  seleccionarCotizacion(cotizacion: any): void {
    console.log('üîò Cotizaci√≥n seleccionada:', cotizacion.id);
    this.cotizacionSeleccionada = cotizacion;
  }

  // ‚úÖ Crear nueva p√≥liza desde vista de cotizaciones
  crearNuevaPolizaDesdeTabla(): void {
    console.log('‚ûï Crear nueva p√≥liza desde tabla');
    this.showCotizacionesTable = false;
    this.showCotizacionDetalle = false;
    this.selectEmitirOption('poliza-nueva');
  }

  // ‚úÖ Formatear valor como moneda
  formatCurrency(value: number): string {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value);
  }

  // ‚úÖ M√©todos para manejo del modal SARLAFT
  shouldShowSarlaftModal(): boolean {
    const formData = this.step1Form.form?.value;
    const tipoDocumento = formData?.tipoDocumentoTomador;
    const numeroDocumento = formData?.numeroDocumentoTomador;

    console.log('üîç Validando SARLAFT:', { tipoDocumento, numeroDocumento });

    // Validar si es NIT y n√∫mero espec√≠fico
    return tipoDocumento === 'NIT' && numeroDocumento === '12345678';
  }

  showSarlaftModal(): void {
    console.log('üìã Mostrando modal SARLAFT');
    this.sarlaftModal.visible = true;
  }

  hideSarlaftModal(): void {
    console.log('üìã Ocultando modal SARLAFT');
    this.sarlaftModal.visible = false;
  }

  onSarlaftUpdate(): void {
    console.log('üîÑ Actualizando SARLAFT con:', {
      clientPhone: this.sarlaftClientPhone,
      advisorPhone: this.sarlaftAdvisorPhone,
      mode: this.action,
    });

    // Aqu√≠ se implementar√≠a la l√≥gica de actualizaci√≥n de SARLAFT
    // Por ahora solo ocultamos el modal y avanzamos al siguiente paso
    this.hideSarlaftModal();
    this.nextStep();
  }

  onSarlaftCancel(): void {
    console.log('‚ùå Cancelando actualizaci√≥n SARLAFT');
    this.hideSarlaftModal();
    // No avanzamos al siguiente paso si se cancela
  }

  onSarlaftContinue(): void {
    console.log('‚û°Ô∏è Continuando en modo COTIZAR (informativo)');
    this.hideSarlaftModal();
    this.nextStep();
  }

  private initializeSarlaftModalButtons(): void {
    // Asignar m√©todos a los botones del modal seg√∫n el modo
    if (this.sarlaftModal.primaryButton) {
      if (this.action === PolicyInputAction.EMITIR) {
        // Modo EMITIR: Bot√≥n "Actualizar" (bloqueante)
        this.sarlaftModal.primaryButton.libTbClick = () => this.onSarlaftUpdate();
      } else {
        // Modo COTIZAR: Bot√≥n "Continuar" (informativo)
        this.sarlaftModal.primaryButton.libTbClick = () => this.onSarlaftContinue();
      }
    }

    if (this.sarlaftModal.secondaryButton) {
      // Solo en modo EMITIR hay bot√≥n "Cancelar"
      this.sarlaftModal.secondaryButton.libTbClick = () => this.onSarlaftCancel();
    }
  }

  // ============================================
  // ‚úÖ M√âTODOS PARA VALIDACI√ìN DE DOCUMENTOS
  // ============================================

  /**
   * Valida el formato del documento seg√∫n el tipo seleccionado
   */
  validarDocumento(tipo: string, numero: string): { valido: boolean; error: string } {
    // Nombres amigables para cada tipo de documento
    const nombresDocumento: { [key: string]: string } = {
      'CC': 'la C√©dula de Ciudadan√≠a',
      'CE': 'la C√©dula de Extranjer√≠a',
      'NIT': 'el NIT',
      'PA': 'el Pasaporte',
      'TI': 'la Tarjeta de Identidad'
    };

    if (!tipo) {
      return { valido: false, error: 'Seleccione un tipo de documento' };
    }
    
    const nombreDoc = nombresDocumento[tipo] || 'el documento';
    
    if (!numero) {
      return { valido: false, error: `Ingrese ${nombreDoc}` };
    }

    const reglas = this.documentValidationRules[tipo];
    if (!reglas) {
      return { valido: true, error: '' }; // Si no hay reglas, permitir
    }

    // Limpiar el n√∫mero para validaci√≥n (excepto para NIT que puede tener gui√≥n)
    const numeroLimpio = tipo === 'NIT' ? numero : numero.replace(/[^A-Za-z0-9]/g, '');
    
    // Validar longitud m√≠nima
    if (numeroLimpio.length < reglas.min) {
      return { 
        valido: false, 
        error: `${nombreDoc} debe tener m√≠nimo ${reglas.min} d√≠gitos` 
      };
    }
    
    // Validar longitud m√°xima
    if (numeroLimpio.length > reglas.max) {
      return { 
        valido: false, 
        error: `${nombreDoc} debe tener m√°ximo ${reglas.max} d√≠gitos` 
      };
    }
    
    // Validar patr√≥n
    if (!reglas.pattern.test(numeroLimpio)) {
      return { 
        valido: false, 
        error: reglas.message 
      };
    }
    
    return { valido: true, error: '' };
  }

  /**
   * Valida el documento del Tomador al cambiar
   */
  validarDocumentoTomador(): void {
    const resultado = this.validarDocumento(this.tipoDocumentoTomador, this.numeroDocumentoTomador);
    this.errorDocumentoTomador = resultado.error;
    
    // Buscar nombre mientras escribe (m√≠nimo 5 caracteres)
    // Incluso si no es completamente v√°lido, intentamos buscar
    if (this.numeroDocumentoTomador && this.numeroDocumentoTomador.length >= 5) {
      this.buscarNombreTomador();
    } else {
      this.nombreTomador = '';
      this.buscandoTomador = false;
    }
  }

  /**
   * Valida el documento del Asegurado al cambiar
   */
  validarDocumentoAsegurado(): void {
    const resultado = this.validarDocumento(this.tipoDocumentoAsegurado, this.numeroDocumentoAsegurado);
    this.errorDocumentoAsegurado = resultado.error;
    
    // Buscar nombre mientras escribe (m√≠nimo 5 caracteres)
    // Incluso si no es completamente v√°lido, intentamos buscar
    if (this.numeroDocumentoAsegurado && this.numeroDocumentoAsegurado.length >= 5) {
      this.buscarNombreAsegurado();
    } else {
      this.nombreAsegurado = '';
      this.buscandoAsegurado = false;
    }
  }

  /**
   * Obtiene el placeholder seg√∫n el tipo de documento
   */
  getPlaceholderDocumento(tipo: string): string {
    const placeholders: { [key: string]: string } = {
      'CC': 'Ej: 1234567890',
      'CE': 'Ej: 1234567',
      'NIT': 'Ej: 900123456-7',
      'PA': 'Ej: AB1234567',
      'TI': 'Ej: 12345678901'
    };
    return placeholders[tipo] || 'Ingrese n√∫mero de documento';
  }

  /**
   * Obtiene el nombre amigable del documento para mensajes
   */
  getNombreDocumento(tipo: string): string {
    const nombres: { [key: string]: string } = {
      'CC': 'La C√©dula de Ciudadan√≠a',
      'CE': 'La C√©dula de Extranjer√≠a',
      'NIT': 'El NIT',
      'PA': 'El Pasaporte',
      'TI': 'La Tarjeta de Identidad'
    };
    return nombres[tipo] || 'El n√∫mero de documento';
  }

  /**
   * Maneja el cambio de tipo de documento y limpia los campos relacionados
   */
  onTipoDocumentoChange(campo: 'tomador' | 'asegurado'): void {
    if (campo === 'tomador') {
      this.numeroDocumentoTomador = '';
      this.nombreTomador = '';
      this.errorDocumentoTomador = '';
      this.buscandoTomador = false;
    } else {
      this.numeroDocumentoAsegurado = '';
      this.nombreAsegurado = '';
      this.errorDocumentoAsegurado = '';
      this.buscandoAsegurado = false;
    }
  }

  /**
   * Obtiene el tipo de input seg√∫n el tipo de documento
   */
  getInputType(tipo: string): string {
    // Solo NIT y PA permiten caracteres especiales/letras
    return (tipo === 'PA') ? 'text' : 'text';
  }

  /**
   * Formatea autom√°ticamente el NIT mientras se escribe
   */
  formatearNIT(event: Event): void {
    const input = event.target as HTMLInputElement;
    let valor = input.value.replace(/[^0-9]/g, '');
    
    // Si tiene m√°s de 9 d√≠gitos, agregar gui√≥n antes del d√≠gito verificador
    if (valor.length > 9) {
      valor = valor.substring(0, 9) + '-' + valor.substring(9, 10);
    }
    
    input.value = valor;
    this.numeroDocumentoTomador = valor;
  }

  /**
   * Restringe entrada solo a n√∫meros
   */
  soloNumeros(event: KeyboardEvent): boolean {
    const charCode = event.which || event.keyCode;
    // Permitir: backspace, delete, tab, escape, enter, punto decimal
    if ([8, 9, 27, 13, 46].includes(charCode)) {
      return true;
    }
    // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
    if ((event.ctrlKey || event.metaKey) && [65, 67, 86, 88].includes(charCode)) {
      return true;
    }
    // Solo permitir n√∫meros
    if (charCode < 48 || charCode > 57) {
      event.preventDefault();
      return false;
    }
    return true;
  }

  /**
   * Restringe entrada a alfanum√©rico
   */
  soloAlfanumerico(event: KeyboardEvent): boolean {
    const charCode = event.which || event.keyCode;
    // Permitir: backspace, delete, tab, escape, enter
    if ([8, 9, 27, 13].includes(charCode)) {
      return true;
    }
    // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
    if ((event.ctrlKey || event.metaKey) && [65, 67, 86, 88].includes(charCode)) {
      return true;
    }
    // Permitir n√∫meros (48-57) y letras (65-90, 97-122)
    if ((charCode >= 48 && charCode <= 57) || 
        (charCode >= 65 && charCode <= 90) || 
        (charCode >= 97 && charCode <= 122)) {
      return true;
    }
    event.preventDefault();
    return false;
  }

  // ‚úÖ M√âTODOS PARA B√öSQUEDA DE NOMBRES
  // ============================================
  
  buscarNombreTomador(): void {
    if (this.numeroDocumentoTomador && this.numeroDocumentoTomador.length >= 5 && !this.errorDocumentoTomador) {
      this.buscandoTomador = true;
      this.nombreTomador = '';
      
      // Simular b√∫squeda con timeout
      setTimeout(() => {
        // Datos de prueba - simular respuesta del servidor
        const mockData: { [key: string]: string } = {
          '900123456': 'EMPRESA CONSTRUCTORA ABC S.A.S.',
          '800987654': 'INVERSIONES DEL VALLE LTDA',
          '11111111': '', // Trigger modal Tomador no creado
          '22222222': '', // Trigger modal SARLAFT desactualizado
          '33333333': '', // Trigger modal Solicitar Cupo (sin cupo disponible)
          '12345678': 'COMERCIALIZADORA NACIONAL S.A.',
        };
        
        const docNum = this.numeroDocumentoTomador.replace(/[^0-9]/g, '');
        
        // Escenario 1: Tomador no creado
        if (docNum === '11111111') {
          this.buscandoTomador = false;
          this.showClienteNoCreado = true;
          return;
        }
        
        // Escenario 2: SARLAFT desactualizado
        if (docNum === '22222222') {
          this.buscandoTomador = false;
          this.showSarlaftDesactualizado = true;
          return;
        }

        // Escenario 3: Sin cupo disponible - Solicitar cupo
        if (docNum === '33333333') {
          this.buscandoTomador = false;
          this.nombreTomador = 'EMPRESA SIN CUPO DISPONIBLE S.A.S.';
          this.showSolicitarCupo = true;
          return;
        }
        
        this.nombreTomador = mockData[docNum] || 'CLIENTE ENCONTRADO - ' + docNum;
        this.buscandoTomador = false;
      }, 1000);
    }
  }

  buscarNombreAsegurado(): void {
    if (this.numeroDocumentoAsegurado && this.numeroDocumentoAsegurado.length >= 5 && !this.errorDocumentoAsegurado) {
      this.buscandoAsegurado = true;
      this.nombreAsegurado = '';
      
      setTimeout(() => {
        const mockData: { [key: string]: string } = {
          '900111222': 'ASEGURADO PRINCIPAL S.A.',
          '800333444': 'BENEFICIARIO EJEMPLO LTDA',
          '12345678': 'ASEGURADO COMERCIAL S.A.S.',
        };
        
        const docNum = this.numeroDocumentoAsegurado.replace(/[^0-9]/g, '');
        this.nombreAsegurado = mockData[docNum] || 'ASEGURADO ENCONTRADO - ' + docNum;
        this.buscandoAsegurado = false;
      }, 1000);
    }
  }

  // ============================================
  // ‚úÖ M√âTODOS PARA MODAL CLIENTE NO CREADO
  // ============================================

  closeClienteNoCreado(): void {
    this.showClienteNoCreado = false;
    this.celularCliente = '';
    this.celularAsesor = '';
  }

  continuarRegistroCliente(): void {
    console.log('‚úÖ Continuando registro de cliente:', {
      celularCliente: this.celularCliente,
      celularAsesor: this.celularAsesor
    });
    this.showClienteNoCreado = false;
    // Mostrar notificaci√≥n
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Registro de cliente iniciado',
      class: 'snackbar-success-theme'
    };
  }

  // ‚úÖ M√©todo para regresar al paso 1 desde el modal Cliente no creado
  regresarPasoUno(): void {
    console.log('‚¨ÖÔ∏è Regresando al paso 1 desde modal Cliente no creado');
    this.showClienteNoCreado = false;
    // Limpiar campos del modal
    this.celularCliente = '';
    this.celularAsesor = '';
    this.correoTomador = '';
    this.correoAsesor = '';
    // Regresar al paso 1
    this.currentStep = 0;
    this.stepperConfig.activeIndex = 0;
  }

  // ‚úÖ M√©todo para crear cliente desde el modal
  crearCliente(): void {
    console.log('üë§ Creando cliente con datos:', {
      celularCliente: this.celularCliente,
      celularAsesor: this.celularAsesor,
      correoTomador: this.correoTomador,
      correoAsesor: this.correoAsesor
    });
    this.showClienteNoCreado = false;
    // Mostrar notificaci√≥n de √©xito
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Cliente creado exitosamente',
      class: 'snackbar-success-theme'
    };
    // Limpiar campos
    this.celularCliente = '';
    this.celularAsesor = '';
    this.correoTomador = '';
    this.correoAsesor = '';
  }

  // ============================================
  // ‚úÖ M√âTODOS PARA MODAL SARLAFT DESACTUALIZADO
  // ============================================

  closeSarlaftDesactualizado(): void {
    this.showSarlaftDesactualizado = false;
    this.celularCliente = '';
    this.celularAsesor = '';
    this.correoTomador = '';
    this.correoAsesor = '';
  }

  // ‚úÖ M√©todo para regresar al paso 1 desde el modal SARLAFT
  regresarPasoUnoSarlaft(): void {
    console.log('‚¨ÖÔ∏è Regresando al paso 1 desde modal SARLAFT');
    this.showSarlaftDesactualizado = false;
    // Limpiar campos del modal
    this.celularCliente = '';
    this.celularAsesor = '';
    this.correoTomador = '';
    this.correoAsesor = '';
    // Regresar al paso 1
    this.currentStep = 0;
    this.stepperConfig.activeIndex = 0;
  }

  continuarActualizacionSarlaft(): void {
    console.log('‚úÖ Continuando actualizaci√≥n SARLAFT:', {
      celularCliente: this.celularCliente,
      celularAsesor: this.celularAsesor
    });
    this.showSarlaftDesactualizado = false;
    // Mostrar notificaci√≥n
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Actualizaci√≥n SARLAFT iniciada',
      class: 'snackbar-success-theme'
    };
  }

  // ============================================
  // ‚úÖ M√âTODOS PARA MODAL SOLICITAR CUPO
  // ============================================

  // ‚úÖ Mostrar modal de solicitar cupo (cuando el tomador no tiene cupo disponible)
  showSolicitarCupoModal(): void {
    console.log('üí∞ Mostrando modal de solicitar cupo');
    this.showSolicitarCupo = true;
  }

  // ‚úÖ Cerrar modal de solicitar cupo
  closeSolicitarCupo(): void {
    console.log('‚ùå Cerrando modal de solicitar cupo');
    this.showSolicitarCupo = false;
    this.estadosFinancierosFile = null;
    this.estadosFinancierosFileName = null;
    this.actividadEconomica = '';
    this.isUploadingEstadosFinancieros = false;
    this.uploadProgressEstadosFinancieros = 0;
  }

  // ‚úÖ Regresar al paso 1 desde modal solicitar cupo
  regresarPasoUnoSolicitarCupo(): void {
    console.log('‚¨ÖÔ∏è Regresando al paso 1 desde modal solicitar cupo');
    this.closeSolicitarCupo();
    this.currentStep = 0;
    this.stepperConfig.activeIndex = 0;
  }


  // ‚úÖ Sub-pasos del Paso 2
  subPasoActual = 1; // Siempre empieza en 1
  subPasos = [
    { num: 1, nombre: 'Datos Generales' },
    { num: 2, nombre: 'Agentes' },
    { num: 3, nombre: 'Ubicaci√≥n' },
    { num: 4, nombre: 'Datos Adicionales' },
    { num: 5, nombre: 'Coaseguro' },
    { num: 6, nombre: 'Detalles' },
    { num: 7, nombre: 'Coberturas' },
    { num: 8, nombre: 'Resp. Civil' }
  ];

  irASubPaso(num: number): void {
    this.subPasoActual = num;
    // Hacer scroll a la secci√≥n correspondiente
    const el = document.getElementById(`seccion-${num}`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  siguienteSubPaso(): void {
    if (this.subPasoActual < 8) {
      this.subPasoActual++;
    } else {
      this.nextStep();
    }
  }

  anteriorSubPaso(): void {
    if (this.subPasoActual > 1) {
      this.subPasoActual--;
    } else {
      this.previousStep();
    }
  }

  // ‚úÖ Seleccionar archivo de estados financieros
  onSelectEstadosFinancieros(event: Event): void {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files.length > 0) {
      const file = input.files[0];
      console.log('üìÑ Archivo de estados financieros seleccionado:', file.name);
      
      // Validar tama√±o (m√°ximo 10MB)
      if (file.size > 10 * 1024 * 1024) {
        this.snackbarConfig = {
          ...this.snackbarConfig,
          show: true,
          message: '‚ùå El archivo no puede superar los 10 MB',
          class: 'snackbar-error-theme'
        };
        return;
      }

      // Simular subida
      this.estadosFinancierosFile = file;
      this.estadosFinancierosFileName = file.name;
      this.isUploadingEstadosFinancieros = true;
      this.uploadProgressEstadosFinancieros = 0;

      // Simular progreso de carga
      const interval = setInterval(() => {
        this.uploadProgressEstadosFinancieros += 10;
        if (this.uploadProgressEstadosFinancieros >= 100) {
          clearInterval(interval);
          this.isUploadingEstadosFinancieros = false;
          console.log('‚úÖ Estados financieros cargados:', file.name);
        }
      }, 150);
    }
  }

  // ‚úÖ Eliminar archivo de estados financieros
  removeEstadosFinancieros(): void {
    console.log('üóëÔ∏è Eliminando archivo de estados financieros');
    this.estadosFinancierosFile = null;
    this.estadosFinancierosFileName = null;
    this.isUploadingEstadosFinancieros = false;
    this.uploadProgressEstadosFinancieros = 0;
  }

  // ‚úÖ Solicitar cupo
  solicitarCupo(): void {
    // Validar que se haya cargado archivo y seleccionado actividad econ√≥mica
    if (!this.estadosFinancierosFileName) {
      this.snackbarConfig = {
        ...this.snackbarConfig,
        show: true,
        message: '‚ùå Debe cargar los estados financieros',
        class: 'snackbar-error-theme'
      };
      return;
    }

    if (!this.actividadEconomica) {
      this.snackbarConfig = {
        ...this.snackbarConfig,
        show: true,
        message: '‚ùå Debe seleccionar una actividad econ√≥mica',
        class: 'snackbar-error-theme'
      };
      return;
    }

    console.log('‚úÖ Solicitando cupo:', {
      estadosFinancieros: this.estadosFinancierosFileName,
      actividadEconomica: this.actividadEconomica
    });

    // Cerrar modal y mostrar notificaci√≥n de √©xito
    this.closeSolicitarCupo();
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Solicitud de cupo enviada exitosamente. Ser√° procesada en breve.',
      class: 'snackbar-success-theme'
    };
  }

  // ============================================
  // ‚úÖ M√âTODOS PARA MODAL ADICIONAR AGENTE
  // ============================================

  abrirModalAgente(): void {
    this.showModalAgente = true;
    this.agenteClave = '';
    this.agenteNombre = '';
    this.agenteParticipacion = 0;
    this.agenteFormaActuacion = '';
    this.agenteConvenio = '';
    this.errorParticipacion = '';
    this.agenteEditIndex = null;
  }

  cerrarModalAgente(): void {
    this.showModalAgente = false;
    this.errorParticipacion = '';
  }

  buscarAgentePorClave(): void {
    if (this.agenteClave && this.agenteClave.length >= 4) {
      // Simular b√∫squeda de agente
      const mockAgentes: { [key: string]: any } = {
        '53940': { nombre: 'JUAN CARLOS MARTINEZ', formaActuacion: 'Directa', convenio: 'Conv-001' },
        '33074': { nombre: 'MARIA FERNANDA LOPEZ', formaActuacion: 'Indirecta', convenio: 'Conv-002' },
        '78236': { nombre: 'CARLOS ANDRES GOMEZ', formaActuacion: 'Directa', convenio: 'Conv-003' },
        '38361': { nombre: 'ANA PATRICIA RUIZ', formaActuacion: 'Mixta', convenio: 'Conv-004' },
      };

      const agente = mockAgentes[this.agenteClave];
      if (agente) {
        this.agenteNombre = agente.nombre;
        this.agenteFormaActuacion = agente.formaActuacion;
        this.agenteConvenio = agente.convenio;
      } else {
        this.agenteNombre = '';
        this.agenteFormaActuacion = '';
        this.agenteConvenio = '';
      }
    }
  }

  validarParticipacion(): void {
    const disponible = this.porcentajeDisponible;
    
    if (this.agenteParticipacion < 0) {
      this.errorParticipacion = 'El porcentaje no puede ser negativo';
    } else if (this.agenteParticipacion > disponible) {
      this.errorParticipacion = `El porcentaje m√°ximo disponible es ${disponible}%`;
    } else if (this.agenteParticipacion % 1 !== 0) {
      this.errorParticipacion = 'No se permiten decimales';
    } else {
      this.errorParticipacion = '';
    }
  }

  agregarAgente(): void {
    if (!this.agenteClave || !this.agenteNombre || this.errorParticipacion) {
      return;
    }

    const nuevoAgente = {
      clave: this.agenteClave,
      nombre: this.agenteNombre,
      participacion: this.agenteParticipacion,
      formaActuacion: this.agenteFormaActuacion,
      convenio: this.agenteConvenio,
    };

    if (this.agenteEditIndex !== null) {
      // Editar existente
      this.agentesAdicionales[this.agenteEditIndex] = nuevoAgente;
    } else {
      // Agregar nuevo
      this.agentesAdicionales.push(nuevoAgente);
    }

    // Recalcular participaci√≥n del l√≠der
    this.recalcularParticipacionLider();
    this.cerrarModalAgente();
    // Mostrar notificaci√≥n
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: this.agenteEditIndex !== null ? '‚úÖ Agente actualizado' : '‚úÖ Agente agregado',
      class: 'snackbar-success-theme'
    };
  }

  editarAgente(index: number): void {
    const agente = this.agentesAdicionales[index];
    this.agenteClave = agente.clave;
    this.agenteNombre = agente.nombre;
    this.agenteParticipacion = agente.participacion;
    this.agenteFormaActuacion = agente.formaActuacion;
    this.agenteConvenio = agente.convenio;
    this.agenteEditIndex = index;
    this.showModalAgente = true;
  }

  eliminarAgente(index: number): void {
    this.agentesAdicionales.splice(index, 1);
    this.recalcularParticipacionLider();
    // Mostrar notificaci√≥n
    this.snackbarConfig = {
      ...this.snackbarConfig,
      show: true,
      message: '‚úÖ Agente eliminado',
      class: 'snackbar-success-theme'
    };
  }

  recalcularParticipacionLider(): void {
    // La participaci√≥n del l√≠der es fija, no se recalcula
    // Solo validamos que la suma total no exceda 100%
    const totalOtros = this.agentesAdicionales.reduce((sum, a) => sum + a.participacion, 0);
    const totalGeneral = this.liderParticipacion + totalOtros;
    
    console.log('üìä Distribuci√≥n de participaci√≥n:');
    console.log(`   - L√≠der: ${this.liderParticipacion}%`);
    console.log(`   - Otros agentes: ${totalOtros}%`);
    console.log(`   - Total: ${totalGeneral}%`);
    console.log(`   - Disponible: ${100 - totalGeneral}%`);
  }

  // ‚úÖ Ordenar tabla de agentes
  ordenarAgentes(columna: string): void {
    if (this.agentesSortColumn === columna) {
      // Cambiar direcci√≥n si es la misma columna
      this.agentesSortDirection = this.agentesSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      // Nueva columna, empezar con ascendente
      this.agentesSortColumn = columna;
      this.agentesSortDirection = 'asc';
    }

    this.agentesAdicionales.sort((a, b) => {
      let valorA = a[columna];
      let valorB = b[columna];

      // Si es n√∫mero, comparar como n√∫mero
      if (typeof valorA === 'number' && typeof valorB === 'number') {
        return this.agentesSortDirection === 'asc' ? valorA - valorB : valorB - valorA;
      }

      // Si es string, comparar alfab√©ticamente
      valorA = String(valorA).toLowerCase();
      valorB = String(valorB).toLowerCase();

      if (valorA < valorB) return this.agentesSortDirection === 'asc' ? -1 : 1;
      if (valorA > valorB) return this.agentesSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // ‚úÖ Obtener icono de ordenamiento (agentes)
  getSortIcon(columna: string): string {
    if (this.agentesSortColumn !== columna) {
      return 'fa-sort';
    }
    return this.agentesSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
  }

  // ‚úÖ Ordenar tabla de cotizaciones
  ordenarCotizaciones(columna: string): void {
    if (this.cotizacionesSortColumn === columna) {
      this.cotizacionesSortDirection = this.cotizacionesSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.cotizacionesSortColumn = columna;
      this.cotizacionesSortDirection = 'asc';
    }

    this.cotizacionesExistentes.sort((a, b) => {
      let valorA: any;
      let valorB: any;

      // Manejar propiedades anidadas
      if (columna === 'tomador') {
        valorA = a.tomador?.nombre || '';
        valorB = b.tomador?.nombre || '';
      } else {
        valorA = a[columna];
        valorB = b[columna];
      }

      // Si es n√∫mero, comparar como n√∫mero
      if (typeof valorA === 'number' && typeof valorB === 'number') {
        return this.cotizacionesSortDirection === 'asc' ? valorA - valorB : valorB - valorA;
      }

      // Si es string, comparar alfab√©ticamente
      valorA = String(valorA).toLowerCase();
      valorB = String(valorB).toLowerCase();

      if (valorA < valorB) return this.cotizacionesSortDirection === 'asc' ? -1 : 1;
      if (valorA > valorB) return this.cotizacionesSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // ‚úÖ Obtener icono de ordenamiento (cotizaciones)
  getCotizacionesSortIcon(columna: string): string {
    if (this.cotizacionesSortColumn !== columna) {
      return 'fa-sort';
    }
    return this.cotizacionesSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
  }

  // ‚úÖ M√©todos para Coaseguro Cedido
  abrirModalCoaseguroCedido(): void {
    this.coaseguroCedidoEditIndex = null; // Limpiar √≠ndice de edici√≥n
    this.coaseguroCedidoCoaseguradora = '';
    this.coaseguroCedidoParticipacion = 0;
    this.coaseguroCedidoGastosAdmin = 0;
    this.coaseguroCedidoNumeroPol = '';
    this.coaseguroCedidoCertificado = '';
    this.showModalCoaseguroCedido = true;
  }

  cerrarModalCoaseguroCedido(): void {
    this.showModalCoaseguroCedido = false;
    this.coaseguroCedidoEditIndex = null; // Limpiar al cerrar
  }

  // ‚úÖ Manejar cambio de tipo coaseguro - Precargar datos para "Cedido"
  onTipoCoaseguroChange(): void {
    if (this.tipoCoaseguro === 'cedido') {
      // Precargar datos por defecto: Bol√≠var siempre aparece primero y es fijo (sin acciones)
      // Participaci√≥n queda vac√≠a, el usuario la edita manualmente
      this.coasegurosCedidos = [
        {
          coaseguradora: this.COASEGURADORA_BOLIVAR,
          participacion: '', // Vac√≠o como en el sistema viejo
          gastosAdmin: 0,
          numeroPol: '',
          certificado: '',
          esDefecto: true // Marca para saber que es la fila fija de Bol√≠var (sin acciones)
        }
      ];
    } else if (this.tipoCoaseguro === 'sin-coaseguro') {
      // Limpiar coaseguros cuando se selecciona "Sin Coaseguro"
      this.coasegurosCedidos = [];
      // Limpiar tambi√©n coaseguro aceptado
      this.coaseguroAceptadoCoaseguradora = '';
      this.coaseguroAceptadoNumeroPol = '';
      this.coaseguroAceptadoCertificado = '';
      this.coaseguroAceptadoParticipacion = 20;
    } else if (this.tipoCoaseguro === 'aceptado') {
      // Limpiar coaseguros cedidos cuando se cambia a aceptado
      this.coasegurosCedidos = [];
    }
  }

  guardarCoaseguroCedido(): void {
    if (!this.coaseguroCedidoCoaseguradora || !this.coaseguroCedidoParticipacion) return;
    
    const coaseguroData = {
      coaseguradora: this.coaseguroCedidoCoaseguradora,
      participacion: this.coaseguroCedidoParticipacion,
      gastosAdmin: this.coaseguroCedidoGastosAdmin || 0,
      numeroPol: this.coaseguroCedidoNumeroPol,
      certificado: this.coaseguroCedidoCertificado,
      esDefecto: false
    };
    
    if (this.coaseguroCedidoEditIndex !== null) {
      // Editar existente (preservar esDefecto si es Bol√≠var)
      const esDefectoOriginal = this.coasegurosCedidos[this.coaseguroCedidoEditIndex].esDefecto;
      this.coasegurosCedidos[this.coaseguroCedidoEditIndex] = {
        ...coaseguroData,
        esDefecto: esDefectoOriginal
      };
    } else {
      // Agregar nuevo
      this.coasegurosCedidos.push(coaseguroData);
    }
    
    // Calcular autom√°ticamente el porcentaje de Bol√≠var (fila por defecto)
    this.actualizarParticipacionBolivar();
    
    this.cerrarModalCoaseguroCedido();
  }
  
  // ‚úÖ Actualizar autom√°ticamente el porcentaje de Bol√≠var
  actualizarParticipacionBolivar(): void {
    // Sumar participaci√≥n de todas las filas que NO son Bol√≠var
    let sumaOtros = 0;
    this.coasegurosCedidos.forEach(c => {
      if (!c.esDefecto) {
        sumaOtros += Number(c.participacion) || 0;
      }
    });
    
    // Bol√≠var recibe el resto (100 - suma de otros)
    const participacionBolivar = 100 - sumaOtros;
    
    // Actualizar la fila de Bol√≠var
    const bolivarIndex = this.coasegurosCedidos.findIndex(c => c.esDefecto);
    if (bolivarIndex !== -1) {
      this.coasegurosCedidos[bolivarIndex].participacion = participacionBolivar > 0 ? participacionBolivar : 0;
    }
  }

  // ‚úÖ Mostrar alerta de confirmaci√≥n antes de eliminar
  eliminarCoaseguroCedido(index: number): void {
    // No permitir eliminar la fila de Bol√≠var (esDefecto)
    if (this.coasegurosCedidos[index]?.esDefecto) {
      return;
    }
    
    // Guardar el √≠ndice y mostrar la alerta de confirmaci√≥n
    this.coaseguroAEliminarIndex = index;
    this.showAlertaEliminarCoaseguro = true;
  }
  
  // ‚úÖ Cancelar eliminaci√≥n
  cancelarEliminarCoaseguro(): void {
    this.showAlertaEliminarCoaseguro = false;
    this.coaseguroAEliminarIndex = null;
  }
  
  // ‚úÖ Confirmar y ejecutar la eliminaci√≥n
  confirmarEliminarCoaseguro(): void {
    if (this.coaseguroAEliminarIndex !== null) {
      this.coasegurosCedidos.splice(this.coaseguroAEliminarIndex, 1);
      
      // Recalcular el porcentaje de Bol√≠var despu√©s de eliminar
      this.actualizarParticipacionBolivar();
      
      // Recalcular paginaci√≥n si es necesario
      const totalPages = Math.ceil(this.coasegurosCedidos.length / this.coasegurosCedidosPageSize);
      if (this.coasegurosCedidosPage > totalPages && totalPages > 0) {
        this.coasegurosCedidosPage = totalPages;
      }
    }
    
    // Cerrar la alerta
    this.showAlertaEliminarCoaseguro = false;
    this.coaseguroAEliminarIndex = null;
  }

  // ‚úÖ Editar Coaseguro Cedido
  editarCoaseguroCedido(index: number): void {
    const coaseguro = this.coasegurosCedidos[index];
    if (coaseguro) {
      this.coaseguroCedidoEditIndex = index;
      this.coaseguroCedidoCoaseguradora = coaseguro.coaseguradora;
      this.coaseguroCedidoParticipacion = coaseguro.participacion;
      this.coaseguroCedidoGastosAdmin = coaseguro.gastosAdmin;
      this.coaseguroCedidoNumeroPol = coaseguro.numeroPol;
      this.coaseguroCedidoCertificado = coaseguro.certificado;
      this.showModalCoaseguroCedido = true;
    }
  }

  // ‚úÖ Ordenamiento Coaseguros Cedidos
  sortCoasegurosCedidos(column: string): void {
    if (this.coasegurosCedidosSortColumn === column) {
      this.coasegurosCedidosSortDirection = this.coasegurosCedidosSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.coasegurosCedidosSortColumn = column;
      this.coasegurosCedidosSortDirection = 'asc';
    }

    this.coasegurosCedidos.sort((a, b) => {
      let valA = a[column];
      let valB = b[column];
      
      if (typeof valA === 'string') {
        valA = valA.toLowerCase();
        valB = valB.toLowerCase();
      }
      
      if (valA < valB) return this.coasegurosCedidosSortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return this.coasegurosCedidosSortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }

  getSortIconCoaseguros(column: string): string {
    if (this.coasegurosCedidosSortColumn !== column) {
      return 'fa-sort';
    }
    return this.coasegurosCedidosSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
  }

  // ‚úÖ Paginaci√≥n Coaseguros Cedidos
  get coasegurosCedidosPageStart(): number {
    return (this.coasegurosCedidosPage - 1) * this.coasegurosCedidosPageSize;
  }

  get coasegurosCedidosPageEnd(): number {
    return Math.min(this.coasegurosCedidosPageStart + this.coasegurosCedidosPageSize, this.coasegurosCedidos.length);
  }

  get coasegurosCedidosPaginados(): any[] {
    return this.coasegurosCedidos
      .map((item, index) => ({ ...item, indexOriginal: index }))
      .slice(this.coasegurosCedidosPageStart, this.coasegurosCedidosPageEnd);
  }

  coasegurosCedidosPrevPage(): void {
    if (this.coasegurosCedidosPage > 1) {
      this.coasegurosCedidosPage--;
    }
  }

  coasegurosCedidosNextPage(): void {
    if (this.coasegurosCedidosPageEnd < this.coasegurosCedidos.length) {
      this.coasegurosCedidosPage++;
    }
  }
}
